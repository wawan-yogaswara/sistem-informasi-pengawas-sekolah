<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Fix Dialog Wawan Final</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .success { border-color: #4CAF50; background: #f0fff0; }
        .error { border-color: #f44336; background: #fff0f0; }
        .warning { border-color: #ff9800; background: #fff8e1; }
        .info { border-color: #2196F3; background: #f0f8ff; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover { background: #0056b3; }
        .success-btn { background: #28a745; }
        .success-btn:hover { background: #218838; }
        .danger-btn { background: #dc3545; }
        .danger-btn:hover { background: #c82333; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .console-code {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Ultimate Fix Dialog Wawan Final</h1>
        <p>Tool terakhir untuk memaksa dialog aktivitas Wawan menampilkan data yang benar</p>

        <div class="step warning">
            <h3>‚ö†Ô∏è Masalah</h3>
            <p>Dialog aktivitas Wawan masih menampilkan kosong meskipun data sudah ada di localStorage dan API sudah diperbaiki.</p>
        </div>

        <div class="step info">
            <h3>üéØ Solusi Ultimate</h3>
            <p>Kita akan memaksa komponen React untuk menggunakan data localStorage secara langsung.</p>
            
            <button onclick="executeUltimateFix()" class="success-btn">üöÄ ULTIMATE FIX</button>
            <button onclick="testCurrentData()">üìä Test Data Saat Ini</button>
            <button onclick="injectDirectToDialog()">üíâ Inject Langsung ke Dialog</button>
        </div>

        <div class="step">
            <h3>üìä Status & Results</h3>
            <div id="status">Klik tombol untuk memulai...</div>
        </div>

        <div class="step info">
            <h3>üîß Manual Fix (Copy ke Console Browser)</h3>
            <p>Jika tombol tidak bekerja, buka Developer Tools (F12) di halaman users, masuk ke Console, dan paste kode ini:</p>
            <div class="console-code" id="manualCode">
// Kode akan muncul setelah klik tombol
            </div>
            <button onclick="copyToClipboard()">üìã Copy Code</button>
        </div>
    </div>

    <script>
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function executeUltimateFix() {
            updateStatus('üöÄ Executing Ultimate Fix...', 'info');
            
            try {
                // Step 1: Get and fix localStorage data
                const localDb = JSON.parse(localStorage.getItem('local-database') || '{}');
                
                // Ensure all Wawan data has proper identifiers
                const fixWawanData = (items, type) => {
                    if (!items || !Array.isArray(items)) return [];
                    
                    return items.map(item => {
                        const isWawanItem = 
                            item.userId === 'wawan' ||
                            (item.username && item.username.toLowerCase() === 'wawan') ||
                            (item.title && item.title.toLowerCase().includes('wawan')) ||
                            (item.name && item.name.toLowerCase().includes('wawan')) ||
                            (item.schoolName && item.schoolName.toLowerCase().includes('wawan')) ||
                            (item.description && item.description.toLowerCase().includes('wawan')) ||
                            (item.notes && item.notes.toLowerCase().includes('wawan')) ||
                            (item.findings && item.findings.toLowerCase().includes('wawan'));
                        
                        if (isWawanItem) {
                            return {
                                ...item,
                                userId: 'wawan',
                                username: 'wawan',
                                createdBy: 'wawan',
                                assignedTo: 'wawan'
                            };
                        }
                        
                        return item;
                    });
                };

                const updatedData = {
                    ...localDb,
                    tasks: fixWawanData(localDb.tasks || [], 'task'),
                    supervisions: fixWawanData(localDb.supervisions || [], 'supervision'),
                    events: fixWawanData(localDb.events || [], 'event'),
                    additionalTasks: fixWawanData(localDb.additionalTasks || [], 'additional task')
                };

                localStorage.setItem('local-database', JSON.stringify(updatedData));

                // Step 2: Create multiple cache entries for the dialog
                const wawanActivities = {
                    tasks: updatedData.tasks.filter(t => t.userId === 'wawan'),
                    supervisions: updatedData.supervisions.filter(s => s.userId === 'wawan'),
                    events: updatedData.events.filter(e => e.userId === 'wawan'),
                    additionalTasks: updatedData.additionalTasks.filter(at => at.userId === 'wawan')
                };

                // Store in multiple possible cache keys
                const cacheKeys = [
                    'wawan-activities',
                    'user-wawan-activities',
                    'activities-wawan',
                    'user-activities-wawan',
                    'dialog-activities-wawan'
                ];

                cacheKeys.forEach(key => {
                    localStorage.setItem(key, JSON.stringify(wawanActivities));
                });

                // Step 3: Create manual code for browser console
                const manualCode = `
// Ultimate Fix untuk Dialog Wawan - Paste di Console Browser
(function() {
    console.log('üöÄ Starting Ultimate Dialog Fix...');
    
    // Force override localStorage data
    const wawanData = ${JSON.stringify(wawanActivities, null, 2)};
    
    // Store in all possible cache locations
    const cacheKeys = ['wawan-activities', 'user-wawan-activities', 'activities-wawan'];
    cacheKeys.forEach(key => {
        localStorage.setItem(key, JSON.stringify(wawanData));
        console.log('‚úÖ Cached:', key);
    });
    
    // Override the dialog component's data loading function
    if (window.React && window.React.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED) {
        console.log('‚öõÔ∏è React detected, attempting component override...');
        
        // Force refresh any React Query cache
        if (window.queryClient) {
            window.queryClient.invalidateQueries();
            console.log('üîÑ React Query cache invalidated');
        }
    }
    
    // Set force refresh flags
    localStorage.setItem('force-dialog-refresh', Date.now());
    localStorage.setItem('wawan-dialog-override', 'true');
    
    console.log('‚úÖ Ultimate fix applied!');
    console.log('üìä Wawan data:', wawanData);
    console.log('üéØ Total items:', ${wawanActivities.tasks.length + wawanActivities.supervisions.length + wawanActivities.events.length + wawanActivities.additionalTasks.length});
    
    // Try to trigger a page refresh
    if (confirm('Fix applied! Refresh page to see changes?')) {
        window.location.reload();
    }
})();`;

                document.getElementById('manualCode').textContent = manualCode;

                const totalItems = wawanActivities.tasks.length + wawanActivities.supervisions.length + 
                                 wawanActivities.events.length + wawanActivities.additionalTasks.length;

                if (totalItems > 0) {
                    updateStatus(`‚úÖ ULTIMATE FIX APPLIED! Found ${totalItems} Wawan activities. Manual code ready for browser console.`, 'success');
                } else {
                    updateStatus('‚ö†Ô∏è No Wawan data found in localStorage. Check if data exists first.', 'warning');
                }

            } catch (error) {
                updateStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function testCurrentData() {
            updateStatus('üìä Testing current data...', 'info');
            
            try {
                const localDb = JSON.parse(localStorage.getItem('local-database') || '{}');
                
                const wawanTasks = (localDb.tasks || []).filter(t => 
                    t.userId === 'wawan' || 
                    (t.username && t.username.toLowerCase() === 'wawan') ||
                    (t.title && t.title.toLowerCase().includes('wawan'))
                );
                
                const wawanSupervisions = (localDb.supervisions || []).filter(s => 
                    s.userId === 'wawan' || 
                    (s.username && s.username.toLowerCase() === 'wawan') ||
                    (s.schoolName && s.schoolName.toLowerCase().includes('wawan'))
                );
                
                const wawanEvents = (localDb.events || []).filter(e => 
                    e.userId === 'wawan' || 
                    (e.username && e.username.toLowerCase() === 'wawan') ||
                    (e.title && e.title.toLowerCase().includes('wawan'))
                );
                
                const wawanAdditionalTasks = (localDb.additionalTasks || []).filter(at => 
                    at.userId === 'wawan' || 
                    (at.username && at.username.toLowerCase() === 'wawan') ||
                    (at.name && at.name.toLowerCase().includes('wawan'))
                );

                const total = wawanTasks.length + wawanSupervisions.length + wawanEvents.length + wawanAdditionalTasks.length;

                const results = {
                    total,
                    tasks: wawanTasks.length,
                    supervisions: wawanSupervisions.length,
                    events: wawanEvents.length,
                    additionalTasks: wawanAdditionalTasks.length,
                    sampleData: {
                        task: wawanTasks[0]?.title || 'None',
                        supervision: wawanSupervisions[0]?.schoolName || 'None',
                        event: wawanEvents[0]?.title || 'None',
                        additionalTask: wawanAdditionalTasks[0]?.name || 'None'
                    }
                };

                updateStatus(`üìä Current Data: ${total} total items found for Wawan<br><pre>${JSON.stringify(results, null, 2)}</pre>`, total > 0 ? 'success' : 'warning');

            } catch (error) {
                updateStatus(`‚ùå Test error: ${error.message}`, 'error');
            }
        }

        function injectDirectToDialog() {
            updateStatus('üíâ Injecting directly to dialog...', 'info');
            
            try {
                // Create a script that will run on the users page
                const injectionScript = `
// Direct Dialog Injection Script
(function() {
    // Wait for dialog to be available
    const waitForDialog = setInterval(() => {
        const dialog = document.querySelector('[role="dialog"]');
        if (dialog) {
            console.log('üéØ Dialog found, injecting data...');
            
            // Override dialog content
            const dialogContent = dialog.querySelector('.space-y-4, .grid, .tabs-content');
            if (dialogContent) {
                const wawanData = JSON.parse(localStorage.getItem('local-database') || '{}');
                const wawanTasks = (wawanData.tasks || []).filter(t => 
                    t.userId === 'wawan' || 
                    (t.username && t.username.toLowerCase() === 'wawan') ||
                    (t.title && t.title.toLowerCase().includes('wawan'))
                );
                
                if (wawanTasks.length > 0) {
                    console.log('‚úÖ Injecting', wawanTasks.length, 'tasks into dialog');
                    // Force update dialog content
                    const event = new CustomEvent('forceDialogUpdate', { 
                        detail: { 
                            tasks: wawanTasks,
                            userId: 'wawan' 
                        } 
                    });
                    dialog.dispatchEvent(event);
                }
            }
            
            clearInterval(waitForDialog);
        }
    }, 1000);
    
    // Stop waiting after 10 seconds
    setTimeout(() => clearInterval(waitForDialog), 10000);
})();`;

                // Store injection script
                localStorage.setItem('dialog-injection-script', injectionScript);
                
                updateStatus('üíâ Injection script prepared. Open users page and the script will run automatically.', 'success');

            } catch (error) {
                updateStatus(`‚ùå Injection error: ${error.message}`, 'error');
            }
        }

        function copyToClipboard() {
            const code = document.getElementById('manualCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                updateStatus('üìã Code copied to clipboard! Paste in browser console on users page.', 'success');
            }).catch(() => {
                updateStatus('‚ùå Failed to copy. Please select and copy manually.', 'error');
            });
        }

        // Initialize
        updateStatus('üöÄ Ultimate Fix tool loaded. Click "ULTIMATE FIX" to start.', 'info');
    </script>
</body>
</html>