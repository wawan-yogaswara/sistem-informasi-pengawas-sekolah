<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Fix Browser Sync</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #007bff; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; margin: 8px; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 14px; }
        .status { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .log { max-height: 400px; overflow-y: auto; background: #000; color: #00ff00; padding: 15px; border-radius: 4px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>üöÄ Quick Fix Browser Sync Issue</h1>
    
    <div class="container warning">
        <h3>‚ö†Ô∏è MASALAH</h3>
        <p><strong>Data di Edge tidak muncul di Chrome/Opera/HP</strong></p>
        <p>Data tersimpan di localStorage browser saja, tidak ke Supabase.</p>
    </div>

    <div class="container">
        <h3>üîß QUICK FIX - Pilih Salah Satu:</h3>
        
        <button onclick="quickFixAll()" class="btn-success">
            üöÄ AUTO FIX SEMUA (Recommended)
        </button>
        
        <button onclick="syncEdgeToSupabase()">
            üì§ Sync Data Edge ke Supabase
        </button>
        
        <button onclick="refreshAllBrowsers()">
            üîÑ Refresh Semua Browser dari Supabase
        </button>
        
        <button onclick="emergencyReset()" class="btn-danger">
            üö® Emergency Reset & Sync
        </button>
    </div>

    <div class="container">
        <h3>üìä Status & Log:</h3>
        <div id="log" class="log">
            <div>üîÑ Ready to fix browser sync issue...</div>
            <div>üí° Pilih salah satu tombol di atas untuk memulai perbaikan</div>
        </div>
    </div>

    <div class="container success" style="display: none;" id="successMessage">
        <h3>‚úÖ PERBAIKAN SELESAI!</h3>
        <p><strong>Langkah selanjutnya:</strong></p>
        <ol>
            <li>Buka browser lain (Chrome/Opera/HP)</li>
            <li>Refresh halaman atau login ulang</li>
            <li>Data seharusnya sudah sinkron</li>
            <li>Test input data baru untuk memastikan sync berfungsi</li>
        </ol>
    </div>

    <script>
        // Supabase config
        const SUPABASE_URL = 'https://glhaliktsrcvnznbgxqt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsaGFsaWt0c3Jjdm56bmJneHF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNjYyMjQsImV4cCI6MjA4MTk0MjIyNH0._kaFo2h7rCdouJp2rpb1lmEvlR6gAc0c3AnRjM_PhP4';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : type === 'warning' ? '#ffd43b' : '#00ff00';
            
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function showSuccess() {
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('successMessage').scrollIntoView({ behavior: 'smooth' });
        }

        // 1. AUTO FIX SEMUA
        async function quickFixAll() {
            log('üöÄ MEMULAI AUTO FIX SEMUA...', 'info');
            
            try {
                // Step 1: Cek user session
                const authUser = localStorage.getItem('auth_user');
                if (!authUser) {
                    log('‚ùå Tidak ada user session - silakan login dulu', 'error');
                    return;
                }
                
                const user = JSON.parse(authUser);
                log(`‚úÖ User session: ${user.username}`, 'success');
                
                // Step 2: Test koneksi Supabase
                log('üîó Testing Supabase connection...', 'info');
                const connectionOk = await testConnection();
                if (!connectionOk) {
                    log('‚ùå Koneksi Supabase gagal', 'error');
                    return;
                }
                
                // Step 3: Sync data ke Supabase
                log('üì§ Syncing data ke Supabase...', 'info');
                await syncAllToSupabase();
                
                // Step 4: Refresh dari Supabase
                log('üîÑ Refreshing dari Supabase...', 'info');
                await refreshFromSupabase();
                
                // Step 5: Setup auto-sync
                log('‚öôÔ∏è Setting up auto-sync...', 'info');
                setupAutoSync();
                
                log('‚úÖ AUTO FIX SELESAI! Data sekarang tersinkronisasi.', 'success');
                showSuccess();
                
            } catch (error) {
                log(`‚ùå Error auto fix: ${error.message}`, 'error');
            }
        }

        // 2. Test koneksi
        async function testConnection() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/users?select=count`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (response.ok) {
                    log('‚úÖ Koneksi Supabase OK', 'success');
                    return true;
                } else {
                    log(`‚ùå Koneksi gagal: ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Error koneksi: ${error.message}`, 'error');
                return false;
            }
        }

        // 3. Sync semua data ke Supabase
        async function syncAllToSupabase() {
            const user = JSON.parse(localStorage.getItem('auth_user'));
            
            // Sync tasks
            const tasks = JSON.parse(localStorage.getItem('tasks_data') || '[]');
            log(`üìã Syncing ${tasks.length} tasks...`, 'info');
            
            for (const task of tasks) {
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/tasks`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'resolution=ignore-duplicates'
                        },
                        body: JSON.stringify({
                            user_id: user.id,
                            title: task.title || task.name,
                            category: task.category || 'Umum',
                            description: task.description || '',
                            completed: task.completed || false,
                            date: task.date || new Date().toISOString().split('T')[0],
                            photo1: task.photo1 || task.photo || null
                        })
                    });
                    
                    if (response.ok) {
                        log(`‚úÖ Synced: ${task.title || task.name}`, 'success');
                    }
                } catch (error) {
                    log(`‚ö†Ô∏è Failed to sync: ${task.title || task.name}`, 'warning');
                }
            }
            
            // Sync additional tasks
            const additionalTasks = JSON.parse(localStorage.getItem('additional_tasks_data') || '[]');
            log(`üìã Syncing ${additionalTasks.length} additional tasks...`, 'info');
            
            for (const task of additionalTasks) {
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/additional_tasks`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'resolution=ignore-duplicates'
                        },
                        body: JSON.stringify({
                            user_id: user.id,
                            name: task.name || task.title,
                            date: task.date || new Date().toISOString().split('T')[0],
                            location: task.location || '',
                            organizer: task.organizer || '',
                            description: task.description || '',
                            photo1: task.photo1 || task.photo || null
                        })
                    });
                    
                    if (response.ok) {
                        log(`‚úÖ Synced: ${task.name || task.title}`, 'success');
                    }
                } catch (error) {
                    log(`‚ö†Ô∏è Failed to sync: ${task.name || task.title}`, 'warning');
                }
            }
            
            // Sync schools
            const schools = JSON.parse(localStorage.getItem('schools_data') || '[]');
            log(`üè´ Syncing ${schools.length} schools...`, 'info');
            
            for (const school of schools) {
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/schools`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'resolution=ignore-duplicates'
                        },
                        body: JSON.stringify({
                            user_id: user.id,
                            name: school.name,
                            address: school.address || '',
                            contact: school.contact || school.phone || '',
                            principal_name: school.principal_name || school.principal || ''
                        })
                    });
                    
                    if (response.ok) {
                        log(`‚úÖ Synced: ${school.name}`, 'success');
                    }
                } catch (error) {
                    log(`‚ö†Ô∏è Failed to sync: ${school.name}`, 'warning');
                }
            }
        }

        // 4. Refresh dari Supabase
        async function refreshFromSupabase() {
            try {
                // Refresh tasks
                const tasksResponse = await fetch(`${SUPABASE_URL}/rest/v1/tasks?select=*&order=date.desc`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (tasksResponse.ok) {
                    const tasks = await tasksResponse.json();
                    localStorage.setItem('tasks_data', JSON.stringify(tasks));
                    log(`‚úÖ Refreshed ${tasks.length} tasks`, 'success');
                }
                
                // Refresh additional tasks
                const additionalTasksResponse = await fetch(`${SUPABASE_URL}/rest/v1/additional_tasks?select=*&order=date.desc`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (additionalTasksResponse.ok) {
                    const additionalTasks = await additionalTasksResponse.json();
                    localStorage.setItem('additional_tasks_data', JSON.stringify(additionalTasks));
                    log(`‚úÖ Refreshed ${additionalTasks.length} additional tasks`, 'success');
                }
                
                // Refresh schools
                const schoolsResponse = await fetch(`${SUPABASE_URL}/rest/v1/schools?select=*&order=created_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (schoolsResponse.ok) {
                    const schools = await schoolsResponse.json();
                    localStorage.setItem('schools_data', JSON.stringify(schools));
                    log(`‚úÖ Refreshed ${schools.length} schools`, 'success');
                }
                
            } catch (error) {
                log(`‚ùå Error refreshing: ${error.message}`, 'error');
            }
        }

        // 5. Setup auto-sync
        function setupAutoSync() {
            // Set flag untuk force Supabase sync
            localStorage.setItem('force_supabase_sync', 'true');
            localStorage.setItem('auto_sync_enabled', 'true');
            
            log('‚úÖ Auto-sync enabled', 'success');
            log('üí° Data baru akan otomatis tersync ke Supabase', 'info');
        }

        // Individual functions
        async function syncEdgeToSupabase() {
            log('üì§ Syncing data Edge ke Supabase...', 'info');
            
            const authUser = localStorage.getItem('auth_user');
            if (!authUser) {
                log('‚ùå Tidak ada user session', 'error');
                return;
            }
            
            await syncAllToSupabase();
            log('‚úÖ Sync Edge ke Supabase selesai', 'success');
            showSuccess();
        }

        async function refreshAllBrowsers() {
            log('üîÑ Refreshing semua browser dari Supabase...', 'info');
            
            await refreshFromSupabase();
            log('‚úÖ Refresh selesai - reload halaman untuk melihat perubahan', 'success');
            
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }

        async function emergencyReset() {
            if (!confirm('Ini akan reset dan sync ulang semua data. Lanjutkan?')) {
                return;
            }
            
            log('üö® Emergency reset & sync...', 'warning');
            
            try {
                // Backup data
                const backup = {
                    tasks: localStorage.getItem('tasks_data'),
                    additionalTasks: localStorage.getItem('additional_tasks_data'),
                    schools: localStorage.getItem('schools_data'),
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('emergency_backup_' + Date.now(), JSON.stringify(backup));
                log('‚úÖ Data backup created', 'success');
                
                // Clear and re-sync
                await syncAllToSupabase();
                await refreshFromSupabase();
                setupAutoSync();
                
                log('‚úÖ Emergency reset selesai', 'success');
                showSuccess();
                
            } catch (error) {
                log(`‚ùå Emergency reset error: ${error.message}`, 'error');
            }
        }

        // Auto-run check on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                const authUser = localStorage.getItem('auth_user');
                if (authUser) {
                    const user = JSON.parse(authUser);
                    log(`üë§ Detected user: ${user.username}`, 'info');
                    log('üí° Siap untuk memperbaiki browser sync issue', 'info');
                } else {
                    log('‚ö†Ô∏è Tidak ada user session - silakan login dulu', 'warning');
                }
            }, 1000);
        });
    </script>
</body>
</html>