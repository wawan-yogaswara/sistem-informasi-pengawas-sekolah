<!DOCTYPE html>
<html>
<head>
    <title>Sync Data Antar Port - Fix Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; text-align: center; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .big-button { background: #4caf50; color: white; padding: 20px 40px; border: none; border-radius: 10px; cursor: pointer; font-size: 18px; margin: 10px; }
        .big-button:hover { background: #45a049; }
        .warning-button { background: #ff9800; }
        .warning-button:hover { background: #f57c00; }
        .status { margin: 20px 0; padding: 15px; border-radius: 5px; }
        .success { background: #e8f5e8; border: 2px solid #4caf50; }
        .info { background: #e3f2fd; border: 2px solid #2196f3; }
        .warning { background: #fff3e0; border: 2px solid #ff9800; }
        .step { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 8px; text-align: left; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Sync Data Antar Port</h1>
        <p><strong>Solusi untuk menyinkronkan data antara localhost:5000 dan localhost:5173</strong></p>
        
        <div class="step warning">
            <h3>‚ö†Ô∏è Masalah:</h3>
            <p>Data di <strong>localhost:5173</strong> berbeda dengan <strong>localhost:5000</strong> karena localStorage browser terpisah untuk setiap port.</p>
        </div>

        <div class="step">
            <h3>üéØ Solusi:</h3>
            <p>1. Ambil data dari backend (localhost:5000)</p>
            <p>2. Inject ke localStorage frontend (localhost:5173)</p>
            <p>3. Refresh dashboard untuk menampilkan data yang sama</p>
        </div>
        
        <button class="big-button" onclick="syncDataFromBackend()">
            üîÑ Sync Data dari Backend
        </button>
        
        <button class="big-button warning-button" onclick="checkDataDifference()">
            üîç Cek Perbedaan Data
        </button>
        
        <div id="status" style="display: none;"></div>
    </div>

    <script>
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.style.display = 'block';
            status.innerHTML = message;
            status.className = 'status ' + type;
        }

        async function syncDataFromBackend() {
            showStatus('üîÑ Mengambil data dari backend (localhost:5000)...', 'info');
            
            try {
                // Ambil data dari backend
                const response = await fetch('http://localhost:5000/local-database.json');
                
                if (!response.ok) {
                    throw new Error('Gagal mengambil data dari backend');
                }
                
                const backendData = await response.json();
                
                showStatus('‚úÖ Data berhasil diambil dari backend. Menyinkronkan ke frontend...', 'info');
                
                // Inject data ke localStorage frontend
                localStorage.setItem('local-database', JSON.stringify(backendData));
                
                // Set current user dari data backend
                const wawaUser = backendData.users?.find(user => user.username === 'wawan') || backendData.users?.[1];
                if (wawaUser) {
                    localStorage.setItem('currentUser', JSON.stringify(wawaUser));
                }
                
                showStatus('üéâ Data berhasil disinkronkan! Membuka dashboard...', 'success');
                
                // Buka dashboard di tab baru
                setTimeout(() => {
                    window.open('http://localhost:5173', '_blank');
                }, 2000);
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('‚ùå Error: ' + error.message + '. Menggunakan data fallback...', 'warning');
                
                // Fallback dengan data demo yang sama seperti backend
                const fallbackData = {
                    users: [
                        {
                            id: '1762696525337',
                            username: 'wawan',
                            fullName: 'H. Wawan Yogaswara, S.Pd, M.Pd',
                            role: 'pengawas',
                            photoUrl: '/uploads/1762830374284-750171039.jpg',
                            nip: '196805301994121001',
                            rank: 'Pembina Utama Muda, IV/c',
                            phone: '087733438282'
                        },
                        {
                            id: '1762696424712',
                            username: 'admin',
                            fullName: 'Administrator',
                            role: 'admin',
                            photoUrl: '/uploads/1762984516465-513200650.jpg'
                        }
                    ],
                    tasks: [
                        {
                            id: '1762824574414',
                            userId: '1762696525337',
                            title: 'Input Data Sekolah Binaan',
                            category: 'Perencanaan',
                            completed: true,
                            date: '2024-12-20T00:00:00.000Z'
                        }
                    ],
                    supervisions: [
                        {
                            id: '1762860475743',
                            userId: '1762696525337',
                            schoolName: 'SDN 1 Garut',
                            type: 'Akademik',
                            date: '2024-12-20T00:00:00.000Z'
                        }
                    ],
                    schools: [
                        { id: '1762822466523', name: 'SDN 1 Garut', address: 'Jl. Raya Garut No. 1' },
                        { id: '1762822466524', name: 'SDN 2 Garut', address: 'Jl. Raya Garut No. 2' },
                        { id: '1762822466525', name: 'SDN 3 Garut', address: 'Jl. Raya Garut No. 3' }
                    ],
                    additionalTasks: [
                        {
                            id: '1762824574418',
                            userId: '1762696525337',
                            title: 'Pelatihan Guru Metode Pembelajaran',
                            date: '2024-12-21T00:00:00.000Z'
                        }
                    ]
                };
                
                localStorage.setItem('local-database', JSON.stringify(fallbackData));
                localStorage.setItem('currentUser', JSON.stringify(fallbackData.users[0]));
                
                showStatus('‚úÖ Data fallback berhasil diinjeksi! Membuka dashboard...', 'success');
                
                setTimeout(() => {
                    window.open('http://localhost:5173', '_blank');
                }, 2000);
            }
        }

        async function checkDataDifference() {
            showStatus('üîç Mengecek perbedaan data...', 'info');
            
            try {
                // Data dari localStorage frontend (port 5173)
                const frontendData = JSON.parse(localStorage.getItem('local-database') || '{}');
                
                // Data dari backend (port 5000)
                const backendResponse = await fetch('http://localhost:5000/local-database.json');
                const backendData = backendResponse.ok ? await backendResponse.json() : {};
                
                let report = '<h3>üìä Laporan Perbedaan Data:</h3>';
                report += '<div style="text-align: left;">';
                
                report += '<h4>Frontend (localhost:5173):</h4>';
                report += `‚Ä¢ Users: ${frontendData.users?.length || 0}<br>`;
                report += `‚Ä¢ Tasks: ${frontendData.tasks?.length || 0}<br>`;
                report += `‚Ä¢ Supervisions: ${frontendData.supervisions?.length || 0}<br>`;
                report += `‚Ä¢ Schools: ${frontendData.schools?.length || 0}<br>`;
                report += `‚Ä¢ Additional Tasks: ${frontendData.additionalTasks?.length || 0}<br><br>`;
                
                report += '<h4>Backend (localhost:5000):</h4>';
                report += `‚Ä¢ Users: ${backendData.users?.length || 0}<br>`;
                report += `‚Ä¢ Tasks: ${backendData.tasks?.length || 0}<br>`;
                report += `‚Ä¢ Supervisions: ${backendData.supervisions?.length || 0}<br>`;
                report += `‚Ä¢ Schools: ${backendData.schools?.length || 0}<br>`;
                report += `‚Ä¢ Additional Tasks: ${backendData.additionalTasks?.length || 0}<br><br>`;
                
                const isDifferent = 
                    (frontendData.users?.length || 0) !== (backendData.users?.length || 0) ||
                    (frontendData.tasks?.length || 0) !== (backendData.tasks?.length || 0) ||
                    (frontendData.supervisions?.length || 0) !== (backendData.supervisions?.length || 0);
                
                if (isDifferent) {
                    report += '<h4 style="color: #f44336;">‚ùå Data BERBEDA - Perlu Sinkronisasi</h4>';
                } else {
                    report += '<h4 style="color: #4caf50;">‚úÖ Data SAMA - Tidak Perlu Sinkronisasi</h4>';
                }
                
                report += '</div>';
                
                showStatus(report, isDifferent ? 'warning' : 'success');
                
            } catch (error) {
                showStatus('‚ùå Error saat mengecek data: ' + error.message, 'warning');
            }
        }
    </script>
</body>
</html>