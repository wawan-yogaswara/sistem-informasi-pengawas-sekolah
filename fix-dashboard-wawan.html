<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Dashboard Data - User Wawan</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        .section { 
            margin: 20px 0; 
            padding: 20px; 
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px; 
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .stats { 
            background: rgba(76, 175, 80, 0.2); 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        .error { 
            background: rgba(244, 67, 54, 0.2); 
            color: #ffcdd2; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border: 1px solid rgba(244, 67, 54, 0.3);
        }
        .success { 
            background: rgba(76, 175, 80, 0.2); 
            color: #c8e6c9; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer; 
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }
        .btn-success {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        .btn-success:hover {
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }
        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        h1, h2, h3 {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix Dashboard Data - User Wawan</h1>
        <p>Tool ini akan memperbaiki masalah dashboard yang tidak menampilkan data statistik untuk user Wawan.</p>
        
        <div class="section">
            <h2>üìä Status Dashboard Saat Ini</h2>
            <div id="currentStatus" class="stats">
                <div class="loading"></div> Memuat status...
            </div>
            <button onclick="checkCurrentStatus()">üîÑ Refresh Status</button>
        </div>

        <div class="section">
            <h2>üõ†Ô∏è Perbaikan Data</h2>
            <p>Klik tombol di bawah untuk memperbaiki data dashboard:</p>
            
            <button onclick="fixDashboardData()" class="btn-success">
                ‚úÖ Fix Dashboard Data Wawan
            </button>
            
            <button onclick="createSampleData()" class="btn-success">
                üìä Buat Data Sample
            </button>
            
            <button onclick="clearAllData()" class="btn-danger">
                üóëÔ∏è Hapus Semua Data
            </button>
            
            <div id="fixResults"></div>
        </div>

        <div class="section">
            <h2>üìã Langkah Manual</h2>
            <p>Jika tombol otomatis tidak bekerja, ikuti langkah manual ini:</p>
            <ol>
                <li>Buka Developer Console (F12)</li>
                <li>Jalankan script fix-dashboard-wawan-data.js</li>
                <li>Refresh halaman dashboard</li>
                <li>Periksa apakah data sudah muncul</li>
            </ol>
        </div>

        <div class="section">
            <h2>üîç Debug Information</h2>
            <button onclick="showDebugInfo()">üîç Show Debug Info</button>
            <div id="debugInfo"></div>
        </div>
    </div>

    <script>
        // Check current dashboard status
        function checkCurrentStatus() {
            console.log('üîÑ Checking current dashboard status...');
            
            const currentUser = JSON.parse(localStorage.getItem('auth_user') || localStorage.getItem('currentUser') || '{}');
            const localData = JSON.parse(localStorage.getItem('local-database') || '{}');
            
            let tasks = localData.tasks || [];
            let supervisions = localData.supervisions || [];
            let schools = localData.schools || [];
            let additionalTasks = localData.additionalTasks || [];
            
            // Filter for current user
            if (currentUser.username || currentUser.id) {
                tasks = tasks.filter(task => 
                    task.username === currentUser.username || 
                    task.userId === currentUser.id ||
                    (currentUser.username === 'wawan' && task.userId === '1762696525337')
                );
                
                supervisions = supervisions.filter(supervision => 
                    supervision.username === currentUser.username || 
                    supervision.userId === currentUser.id ||
                    (currentUser.username === 'wawan' && supervision.userId === '1762696525337')
                );
                
                additionalTasks = additionalTasks.filter(task => 
                    task.username === currentUser.username || 
                    task.userId === currentUser.id ||
                    (currentUser.username === 'wawan' && task.userId === '1762696525337')
                );
            }
            
            // Filter out 2024 dummy data
            const currentYear = new Date().getFullYear();
            tasks = tasks.filter(task => {
                const taskDate = new Date(task.date || task.createdAt);
                return taskDate.getFullYear() !== 2024;
            });
            
            supervisions = supervisions.filter(supervision => {
                const supervisionDate = new Date(supervision.date || supervision.createdAt);
                return supervisionDate.getFullYear() !== 2024;
            });
            
            additionalTasks = additionalTasks.filter(task => {
                const taskDate = new Date(task.date || task.createdAt);
                return taskDate.getFullYear() !== 2024;
            });
            
            // Calculate stats
            const completedTasks = tasks.filter(task => 
                task.completed === true || task.status === 'completed'
            ).length;
            
            const currentMonth = new Date().getMonth();
            const monthlySupervisions = supervisions.filter(supervision => {
                const date = new Date(supervision.date || supervision.createdAt);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            }).length;
            
            const stats = {
                totalTasks: tasks.length,
                completedTasks,
                totalSchools: schools.length,
                monthlySupervisions,
                totalSupervisions: supervisions.length,
                totalAdditionalTasks: additionalTasks.length
            };
            
            const statusHtml = `
                <h3>üë§ User: ${currentUser.fullName || currentUser.username || 'Unknown'}</h3>
                <div class="grid">
                    <div class="stat-card">
                        <div>üìã Total Tugas</div>
                        <div class="stat-number">${stats.totalTasks}</div>
                    </div>
                    <div class="stat-card">
                        <div>‚úÖ Tugas Selesai</div>
                        <div class="stat-number">${stats.completedTasks}</div>
                    </div>
                    <div class="stat-card">
                        <div>üè´ Sekolah Binaan</div>
                        <div class="stat-number">${stats.totalSchools}</div>
                    </div>
                    <div class="stat-card">
                        <div>üëÅÔ∏è Supervisi Bulan Ini</div>
                        <div class="stat-number">${stats.monthlySupervisions}</div>
                    </div>
                    <div class="stat-card">
                        <div>üìä Total Supervisi</div>
                        <div class="stat-number">${stats.totalSupervisions}</div>
                    </div>
                    <div class="stat-card">
                        <div>‚ûï Tugas Tambahan</div>
                        <div class="stat-number">${stats.totalAdditionalTasks}</div>
                    </div>
                </div>
                
                <div style="margin-top: 15px;">
                    ${stats.totalTasks === 0 && stats.totalSupervisions === 0 && stats.totalAdditionalTasks === 0 ? 
                        '<div class="error">‚ö†Ô∏è Tidak ada data ditemukan! Dashboard akan menampilkan angka 0 semua.</div>' :
                        '<div class="success">‚úÖ Data ditemukan! Dashboard seharusnya menampilkan statistik ini.</div>'
                    }
                </div>
            `;
            
            document.getElementById('currentStatus').innerHTML = statusHtml;
        }
        
        // Fix dashboard data
        async function fixDashboardData() {
            document.getElementById('fixResults').innerHTML = '<div class="loading"></div> Memperbaiki data...';
            
            try {
                // Load and execute the fix script
                const response = await fetch('fix-dashboard-wawan-data.js');
                const scriptContent = await response.text();
                
                // Execute the script
                const result = eval(scriptContent);
                
                document.getElementById('fixResults').innerHTML = `
                    <div class="success">
                        ‚úÖ Dashboard data berhasil diperbaiki!<br>
                        üìä Statistik baru:<br>
                        - Total Tugas: ${result.totalTasks}<br>
                        - Tugas Selesai: ${result.completedTasks}<br>
                        - Sekolah Binaan: ${result.totalSchools}<br>
                        - Supervisi Bulan Ini: ${result.monthlySupervisions}<br>
                        - Total Supervisi: ${result.totalSupervisions}<br>
                        - Tugas Tambahan: ${result.totalAdditionalTasks}<br><br>
                        üîÑ Silakan refresh halaman dashboard untuk melihat perubahan.
                    </div>
                `;
                
                // Refresh status
                setTimeout(checkCurrentStatus, 1000);
                
            } catch (error) {
                console.error('Error fixing dashboard data:', error);
                document.getElementById('fixResults').innerHTML = `
                    <div class="error">
                        ‚ùå Gagal memperbaiki data: ${error.message}<br>
                        Silakan coba metode manual atau hubungi developer.
                    </div>
                `;
            }
        }
        
        // Create sample data
        function createSampleData() {
            document.getElementById('fixResults').innerHTML = '<div class="loading"></div> Membuat data sample...';
            
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth();
            
            const sampleData = {
                users: [
                    {
                        id: "1762696525337",
                        username: "wawan",
                        fullName: "Wawan Setiawan",
                        role: "user",
                        nip: "196801011990031001"
                    }
                ],
                schools: [
                    { id: "school_001", name: "SDN 1 Garut Kota", address: "Jl. Raya Garut No. 1", headmaster: "Drs. Ahmad Suryadi" },
                    { id: "school_002", name: "SDN 2 Garut Kota", address: "Jl. Raya Garut No. 2", headmaster: "Hj. Siti Nurhasanah, S.Pd" },
                    { id: "school_003", name: "SDN 3 Garut Kota", address: "Jl. Raya Garut No. 3", headmaster: "Drs. Bambang Sutrisno" }
                ],
                tasks: [
                    {
                        id: "task_001",
                        title: "Supervisi Pembelajaran Kelas 1-3",
                        description: "Melakukan supervisi pembelajaran di kelas rendah",
                        userId: "1762696525337",
                        username: "wawan",
                        schoolId: "school_001",
                        schoolName: "SDN 1 Garut Kota",
                        status: "completed",
                        completed: true,
                        date: new Date(currentYear, currentMonth, 5).toISOString(),
                        createdAt: new Date(currentYear, currentMonth, 1).toISOString()
                    },
                    {
                        id: "task_002",
                        title: "Evaluasi Kurikulum Merdeka",
                        description: "Mengevaluasi implementasi kurikulum merdeka",
                        userId: "1762696525337",
                        username: "wawan",
                        schoolId: "school_002",
                        schoolName: "SDN 2 Garut Kota",
                        status: "in_progress",
                        completed: false,
                        date: new Date(currentYear, currentMonth, 10).toISOString(),
                        createdAt: new Date(currentYear, currentMonth, 3).toISOString()
                    }
                ],
                supervisions: [
                    {
                        id: "supervision_001",
                        title: "Supervisi Akademik Semester 1",
                        schoolId: "school_001",
                        schoolName: "SDN 1 Garut Kota",
                        userId: "1762696525337",
                        username: "wawan",
                        date: new Date(currentYear, currentMonth, 8).toISOString(),
                        notes: "Pembelajaran sudah berjalan dengan baik",
                        createdAt: new Date(currentYear, currentMonth, 8).toISOString()
                    }
                ],
                additionalTasks: [
                    {
                        id: "additional_001",
                        title: "Pelatihan Guru Kurikulum Merdeka",
                        description: "Memberikan pelatihan kepada guru-guru",
                        userId: "1762696525337",
                        username: "wawan",
                        schoolId: "school_001",
                        schoolName: "SDN 1 Garut Kota",
                        date: new Date(currentYear, currentMonth, 20).toISOString(),
                        status: "completed",
                        createdAt: new Date(currentYear, currentMonth, 18).toISOString()
                    }
                ]
            };
            
            // Set user data
            const wawaUser = {
                id: "1762696525337",
                username: "wawan",
                fullName: "Wawan Setiawan",
                role: "user",
                nip: "196801011990031001"
            };
            
            localStorage.setItem('auth_user', JSON.stringify(wawaUser));
            localStorage.setItem('currentUser', JSON.stringify(wawaUser));
            localStorage.setItem('user_data', JSON.stringify(wawaUser));
            
            // Save sample data
            localStorage.setItem('local-database', JSON.stringify(sampleData));
            localStorage.setItem('tasks_data', JSON.stringify(sampleData.tasks));
            localStorage.setItem('supervisions_data', JSON.stringify(sampleData.supervisions));
            localStorage.setItem('schools_data', JSON.stringify(sampleData.schools));
            localStorage.setItem('additional_tasks_data', JSON.stringify(sampleData.additionalTasks));
            
            document.getElementById('fixResults').innerHTML = `
                <div class="success">
                    ‚úÖ Data sample berhasil dibuat!<br>
                    - ${sampleData.tasks.length} tugas<br>
                    - ${sampleData.supervisions.length} supervisi<br>
                    - ${sampleData.schools.length} sekolah<br>
                    - ${sampleData.additionalTasks.length} tugas tambahan<br><br>
                    üîÑ Refresh halaman dashboard untuk melihat data baru.
                </div>
            `;
            
            setTimeout(checkCurrentStatus, 1000);
        }
        
        // Clear all data
        function clearAllData() {
            if (confirm('Yakin ingin menghapus semua data? Tindakan ini tidak dapat dibatalkan.')) {
                localStorage.removeItem('local-database');
                localStorage.removeItem('tasks_data');
                localStorage.removeItem('supervisions_data');
                localStorage.removeItem('schools_data');
                localStorage.removeItem('additional_tasks_data');
                
                document.getElementById('fixResults').innerHTML = `
                    <div class="error">
                        üóëÔ∏è Semua data telah dihapus!
                    </div>
                `;
                
                setTimeout(checkCurrentStatus, 1000);
            }
        }
        
        // Show debug information
        function showDebugInfo() {
            const authUser = JSON.parse(localStorage.getItem('auth_user') || '{}');
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const localData = JSON.parse(localStorage.getItem('local-database') || '{}');
            
            document.getElementById('debugInfo').innerHTML = `
                <h3>üîç Debug Information</h3>
                <h4>Auth User:</h4>
                <pre>${JSON.stringify(authUser, null, 2)}</pre>
                
                <h4>Current User:</h4>
                <pre>${JSON.stringify(currentUser, null, 2)}</pre>
                
                <h4>Local Database Structure:</h4>
                <pre>${JSON.stringify({
                    users: localData.users?.length || 0,
                    tasks: localData.tasks?.length || 0,
                    supervisions: localData.supervisions?.length || 0,
                    schools: localData.schools?.length || 0,
                    additionalTasks: localData.additionalTasks?.length || 0
                }, null, 2)}</pre>
            `;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkCurrentStatus();
        });
    </script>
</body>
</html>