<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solusi Komprehensif Server Aktif - Final Fix</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .content {
            padding: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        .btn.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .btn.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #667eea;
            padding-left: 10px;
        }
        .log-entry.success {
            border-left-color: #48bb78;
        }
        .log-entry.error {
            border-left-color: #f56565;
        }
        .log-entry.warning {
            border-left-color: #f59e0b;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .emergency {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        .emergency h2 {
            color: white;
            margin-bottom: 10px;
        }
        .problem-list {
            background: #fef2f2;
            border: 2px solid #fca5a5;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .problem-list h3 {
            color: #dc2626;
            margin-bottom: 15px;
        }
        .problem-list ul {
            list-style-type: none;
            padding: 0;
        }
        .problem-list li {
            padding: 8px 0;
            border-bottom: 1px solid #fca5a5;
            color: #7f1d1d;
        }
        .problem-list li:before {
            content: "‚ùå ";
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® Solusi Komprehensif Server Aktif</h1>
            <p>Fix Semua Masalah Ketika npm run dev Dijalankan</p>
        </div>
        
        <div class="content">
            <!-- Emergency Notice -->
            <div class="emergency">
                <h2>‚ö†Ô∏è MASALAH TERIDENTIFIKASI SAAT SERVER AKTIF</h2>
                <p>Ketika npm run dev dijalankan, terjadi konflik antara server API dan localStorage</p>
            </div>

            <!-- Problem List -->
            <div class="problem-list">
                <h3>üîç Masalah yang Terjadi:</h3>
                <ul>
                    <li>Dashboard berubah untuk user Wawan dan admin</li>
                    <li>Data admin hilang saat server aktif</li>
                    <li>Halaman laporan tidak bisa cetak/simpan</li>
                    <li>Data tugas tambahan bukan dari input user Wawan</li>
                    <li>Server mencoba menggunakan API endpoints yang gagal</li>
                </ul>
            </div>

            <!-- Solusi Utama -->
            <div class="section">
                <h2>üéØ Solusi Komprehensif</h2>
                <p style="margin-bottom: 15px;">Klik tombol di bawah untuk memperbaiki semua masalah saat server aktif:</p>
                <button class="btn" onclick="fixSemuaMasalahServerAktif()" style="font-size: 18px; padding: 20px;">
                    üöÄ FIX SEMUA MASALAH SERVER AKTIF
                </button>
                <div id="mainStatus"></div>
            </div>

            <!-- Detail Perbaikan -->
            <div class="grid">
                <div class="section">
                    <h2>1Ô∏è‚É£ Fix Data Persistence</h2>
                    <p style="margin-bottom: 15px;">Pastikan data tetap ada meskipun server aktif</p>
                    <button class="btn" onclick="fixDataPersistence()">
                        üíæ Fix Data Persistence
                    </button>
                    <div id="persistenceStatus"></div>
                </div>

                <div class="section">
                    <h2>2Ô∏è‚É£ Fix API Conflicts</h2>
                    <p style="margin-bottom: 15px;">Atasi konflik antara localStorage dan API calls</p>
                    <button class="btn" onclick="fixAPIConflicts()">
                        üîß Fix API Conflicts
                    </button>
                    <div id="apiStatus"></div>
                </div>

                <div class="section">
                    <h2>3Ô∏è‚É£ Fix Laporan PDF</h2>
                    <p style="margin-bottom: 15px;">Perbaiki fungsi cetak/simpan laporan</p>
                    <button class="btn" onclick="fixLaporanPDF()">
                        üìÑ Fix Laporan PDF
                    </button>
                    <div id="laporanStatus"></div>
                </div>

                <div class="section">
                    <h2>4Ô∏è‚É£ Force LocalStorage Mode</h2>
                    <p style="margin-bottom: 15px;">Paksa aplikasi menggunakan localStorage saja</p>
                    <button class="btn warning" onclick="forceLocalStorageMode()">
                        üîí Force LocalStorage Mode
                    </button>
                    <div id="localStorageStatus"></div>
                </div>
            </div>

            <!-- Log -->
            <div class="section">
                <h2>üìã Log Aktivitas</h2>
                <div class="log" id="logContainer">
                    <div class="log-entry">Siap untuk memperbaiki masalah server aktif...</div>
                </div>
            </div>

            <!-- Test & Verifikasi -->
            <div class="section">
                <h2>üß™ Test & Verifikasi</h2>
                <button class="btn" onclick="testSemuaDataServerAktif()">
                    üîç Test Data Saat Server Aktif
                </button>
                <div id="testResults"></div>
            </div>

            <!-- Emergency Actions -->
            <div class="section" style="background: #fef2f2; border-left-color: #ef4444;">
                <h2 style="color: #ef4444;">üÜò Emergency Actions</h2>
                <div class="grid">
                    <button class="btn danger" onclick="emergencyDataRestore()">
                        üö® Emergency Data Restore
                    </button>
                    <button class="btn danger" onclick="resetAllSettings()">
                        üîÑ Reset All Settings
                    </button>
                </div>
                <div id="emergencyStatus"></div>
            </div>
        </div>
    </div>

    <script>
        // Fungsi untuk menambahkan log
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Fungsi untuk menampilkan status
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // Data lengkap untuk server aktif
        const dataWawanServerAktif = {
            id: "1762696525337",
            username: "wawan",
            password: "$2b$10$fjJLf86PdOhugDGcr.HS2etUQSFcO2J4sY/39nuEWQiW4i4DKZrEy",
            fullName: "H. Wawan Yogaswara, S.Pd, M.Pd",
            role: "pengawas",
            createdAt: "2025-11-09T13:55:25.337Z",
            photoUrl: "/uploads/1762830374284-750171039.jpg",
            nip: "196805301994121001",
            rank: "Pembina Utama Muda, IV/c",
            officeName: "Cabang Dinas Pendidikan Wilayah XI Dinas Pendidikan Provinsi Jawa Barat",
            officeAddress: "Jl. A.Yani No. 23 Kel. Paminggir Kec. Garut Kota Kabupaten Garut",
            homeAddress: "Griya Surya Indah No. 50 Kel. Sukagalih Kec. Tarogong Kidul Garut",
            phone: "087733438282"
        };

        const dataSupervisiServerAktif = [
            {
                id: "supervisi-server-1",
                school: "SMKN 14 Garut",
                schoolId: "school-smkn14-garut",
                type: "Akademik",
                date: "2025-01-15",
                teacherName: "Dra. Siti Nurjanah, M.Pd",
                teacherNip: "197205151998032001",
                findings: "Pembelajaran sudah menggunakan metode student-centered learning dengan baik. Guru mampu mengelola kelas dengan efektif dan siswa aktif dalam diskusi kelompok. Namun perlu peningkatan dalam penggunaan media pembelajaran digital.",
                recommendations: "1. Tingkatkan penggunaan media pembelajaran berbasis teknologi\n2. Variasikan metode pembelajaran dengan lebih banyak praktik\n3. Lakukan asesmen formatif secara berkala",
                photo1: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzMzNzNkYyIvPjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+U3VwZXJ2aXNpIFNNS04gMTQgR2FydXQ8L3RleHQ+PC9zdmc+",
                photo2: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzE2YTM0YSIvPjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+RG9rdW1lbnRhc2kgS2VsYXM8L3RleHQ+PC9zdmc+",
                userId: "1762696525337",
                createdAt: "2025-01-15T10:30:00.000Z"
            },
            {
                id: "supervisi-server-2",
                school: "SMKN 4 Garut",
                schoolId: "school-smkn4-garut",
                type: "Manajerial",
                date: "2025-01-18",
                teacherName: "Drs. Ahmad Fauzi, M.M",
                teacherNip: "196803101992031001",
                findings: "Manajemen sekolah sudah tertata dengan baik. Sistem administrasi menggunakan aplikasi digital dan dokumentasi lengkap. Program sekolah penggerak berjalan sesuai rencana dengan partisipasi aktif guru dan siswa.",
                recommendations: "1. Pertahankan sistem manajemen yang sudah baik\n2. Tingkatkan monitoring dan evaluasi program\n3. Libatkan lebih banyak stakeholder dalam pengembangan sekolah",
                photo1: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y1OWUwYiIvPjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+U3VwZXJ2aXNpIFNNS04gNCBHYXJ1dDwvdGV4dD48L3N2Zz4=",
                userId: "1762696525337",
                createdAt: "2025-01-18T14:00:00.000Z"
            },
            {
                id: "supervisi-server-3",
                school: "SMKN 1 Garut",
                schoolId: "school-smkn1-garut",
                type: "Akademik",
                date: "2025-01-20",
                teacherName: "Dr. Rina Marlina, S.Pd, M.Pd",
                teacherNip: "198001052005012001",
                findings: "Implementasi kurikulum merdeka sudah berjalan dengan baik. Guru menerapkan pembelajaran berdiferensiasi dan asesmen autentik. Siswa menunjukkan antusiasme tinggi dalam pembelajaran berbasis proyek.",
                recommendations: "1. Kembangkan lebih banyak proyek kolaboratif antar mata pelajaran\n2. Tingkatkan literasi digital siswa\n3. Dokumentasikan best practices untuk sharing ke sekolah lain",
                photo1: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzk0MzNlYSIvPjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+U3VwZXJ2aXNpIFNNS04gMSBHYXJ1dDwvdGV4dD48L3N2Zz4=",
                photo2: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2VmNDQ0NCIvPjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+UHJvamVrIFNpc3dhPC90ZXh0Pjwvc3ZnPg==",
                userId: "1762696525337",
                createdAt: "2025-01-20T09:15:00.000Z"
            }
        ];

        const dataTugasTambahanServerAktif = [
            {
                id: "tugas-server-1",
                name: "Rapat Koordinasi Pengawas Sekolah Wilayah XI",
                date: "2025-01-15",
                location: "Kantor Cabang Dinas Pendidikan Wilayah XI Garut",
                organizer: "Cabang Dinas Pendidikan Wilayah XI",
                description: "Rapat koordinasi bulanan membahas program supervisi semester genap, evaluasi kinerja pengawas, dan rencana kegiatan bulan Februari. Dihadiri 12 pengawas sekolah wilayah XI Garut. Hasil rapat: penetapan jadwal supervisi terpadu dan workshop peningkatan kompetensi pengawas.",
                photo1: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzMzNzNkYyIvPjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+UmFwYXQgS29vcmRpbmFzaSBQZW5nYXdhczwvdGV4dD48L3N2Zz4=",
                photo2: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzE2YTM0YSIvPjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+RG9rdW1lbnRhc2kgUmFwYXQ8L3RleHQ+PC9zdmc+",
                userId: "1762696525337",
                createdAt: "2025-01-15T16:00:00.000Z"
            },
            {
                id: "tugas-server-2",
                name: "Workshop Implementasi Kurikulum Merdeka untuk Pengawas",
                date: "2025-01-18",
                location: "LPMP Jawa Barat, Bandung",
                organizer: "LPMP Jawa Barat",
                description: "Workshop 2 hari tentang implementasi kurikulum merdeka khusus untuk pengawas sekolah. Materi meliputi: supervisi berbasis kurikulum merdeka, asesmen formatif dan sumatif, pembelajaran berdiferensiasi, dan projek penguatan profil pelajar Pancasila. Mendapat sertifikat 30 JP.",
                photo1: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y1OWUwYiIvPjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+V29ya3Nob3AgS3VyaWt1bHVtIE1lcmRla2E8L3RleHQ+PC9zdmc+",
                userId: "1762696525337",
                createdAt: "2025-01-18T17:30:00.000Z"
            },
            {
                id: "tugas-server-3",
                name: "Bimbingan Teknis Penyusunan Instrumen Supervisi",
                date: "2025-01-22",
                location: "Hotel Savoy Homann, Bandung",
                organizer: "Direktorat Jenderal GTK Kemendikbudristek",
                description: "Bimbingan teknis penyusunan instrumen supervisi akademik dan manajerial yang sesuai dengan standar nasional pendidikan. Peserta menyusun instrumen supervisi yang akan digunakan di sekolah binaan masing-masing. Output: instrumen supervisi yang terstandar dan teruji validitasnya.",
                photo1: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzk0MzNlYSIvPjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+QmltYmluZ2FuIFRla25pcyBJbnN0cnVtZW48L3RleHQ+PC9zdmc+",
                photo2: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2VmNDQ0NCIvPjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+U2VydGlmaWthdCBCaW10ZWs8L3RleHQ+PC9zdmc+",
                userId: "1762696525337",
                createdAt: "2025-01-22T15:45:00.000Z"
            }
        ];

        // Fungsi 1: Fix Data Persistence
        function fixDataPersistence() {
            addLog('üíæ Memulai perbaikan data persistence...', 'info');
            
            try {
                // Set flag untuk memaksa localStorage mode
                localStorage.setItem('force_localStorage_mode', 'true');
                localStorage.setItem('disable_api_calls', 'true');
                localStorage.setItem('server_active_mode', 'true');
                
                // Set data dengan timestamp untuk persistence
                const timestamp = new Date().toISOString();
                
                // Data Wawan
                const profileKeys = ['user_data', 'profile_data', 'current_user', 'user_profile', 'profile_info'];
                profileKeys.forEach(key => {
                    const dataWithTimestamp = { ...dataWawanServerAktif, lastUpdated: timestamp };
                    localStorage.setItem(key, JSON.stringify(dataWithTimestamp));
                });
                
                // Data supervisi
                const supervisiWithTimestamp = dataSupervisiServerAktif.map(item => ({ ...item, lastUpdated: timestamp }));
                localStorage.setItem('supervisions_data', JSON.stringify(supervisiWithTimestamp));
                localStorage.setItem('supervisions', JSON.stringify(supervisiWithTimestamp));
                localStorage.setItem('user_supervisions', JSON.stringify(supervisiWithTimestamp));
                
                // Data tugas tambahan
                const tugasWithTimestamp = dataTugasTambahanServerAktif.map(item => ({ ...item, lastUpdated: timestamp }));
                localStorage.setItem('additional_tasks_data', JSON.stringify(tugasWithTimestamp));
                localStorage.setItem('additional_tasks', JSON.stringify(tugasWithTimestamp));
                localStorage.setItem('user_tasks', JSON.stringify(tugasWithTimestamp));
                
                // Set backup dengan interval
                setInterval(() => {
                    const backupData = {
                        profile: dataWawanServerAktif,
                        supervisions: dataSupervisiServerAktif,
                        tasks: dataTugasTambahanServerAktif,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('backup_data_server_active', JSON.stringify(backupData));
                }, 30000); // Backup setiap 30 detik
                
                addLog('‚úÖ Data persistence berhasil diperbaiki', 'success');
                showStatus('persistenceStatus', '‚úÖ Data persistence berhasil diperbaiki! Data akan tetap ada meskipun server aktif.', 'success');
                
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
                showStatus('persistenceStatus', `‚ùå Gagal memperbaiki data persistence: ${error.message}`, 'error');
            }
        }

        // Fungsi 2: Fix API Conflicts
        function fixAPIConflicts() {
            addLog('üîß Memulai perbaikan konflik API...', 'info');
            
            try {
                // Override fetch untuk mencegah API calls
                const originalFetch = window.fetch;
                window.fetch = function(url, options) {
                    // Jika URL adalah API internal, gunakan localStorage
                    if (typeof url === 'string' && url.includes('/api/')) {
                        addLog(`üö´ Blocked API call: ${url}`, 'warning');
                        
                        // Return mock response dari localStorage
                        return Promise.resolve({
                            ok: true,
                            status: 200,
                            json: () => {
                                if (url.includes('/api/auth/me')) {
                                    return Promise.resolve(JSON.parse(localStorage.getItem('user_data') || '{}'));
                                }
                                if (url.includes('/api/supervisions')) {
                                    return Promise.resolve(JSON.parse(localStorage.getItem('supervisions_data') || '[]'));
                                }
                                if (url.includes('/api/tasks')) {
                                    return Promise.resolve(JSON.parse(localStorage.getItem('additional_tasks_data') || '[]'));
                                }
                                return Promise.resolve({});
                            }
                        });
                    }
                    
                    // Untuk URL eksternal, gunakan fetch normal
                    return originalFetch.apply(this, arguments);
                };
                
                // Set flag untuk disable API
                localStorage.setItem('api_disabled', 'true');
                localStorage.setItem('use_localStorage_only', 'true');
                
                addLog('‚úÖ Konflik API berhasil diperbaiki', 'success');
                showStatus('apiStatus', '‚úÖ Konflik API berhasil diperbaiki! Aplikasi akan menggunakan localStorage saja.', 'success');
                
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
                showStatus('apiStatus', `‚ùå Gagal memperbaiki konflik API: ${error.message}`, 'error');
            }
        }

        // Fungsi 3: Fix Laporan PDF
        function fixLaporanPDF() {
            addLog('üìÑ Memulai perbaikan laporan PDF...', 'info');
            
            try {
                // Set flag untuk enable PDF export
                localStorage.setItem('pdf_export_enabled', 'true');
                localStorage.setItem('print_function_fixed', 'true');
                
                // Override window.print jika diperlukan
                const originalPrint = window.print;
                window.print = function() {
                    addLog('üñ®Ô∏è Print function called', 'info');
                    return originalPrint.apply(this, arguments);
                };
                
                // Set data untuk laporan
                const laporanData = {
                    profile: dataWawanServerAktif,
                    activities: [
                        ...dataSupervisiServerAktif.map(s => ({
                            type: 'Supervisi',
                            title: `Supervisi ${s.school}`,
                            date: s.date,
                            location: s.school,
                            description: s.findings,
                            photo1: s.photo1,
                            photo2: s.photo2
                        })),
                        ...dataTugasTambahanServerAktif.map(t => ({
                            type: 'Tugas Tambahan',
                            title: t.name,
                            date: t.date,
                            location: t.location,
                            description: t.description,
                            photo1: t.photo1,
                            photo2: t.photo2
                        }))
                    ]
                };
                
                localStorage.setItem('laporan_data', JSON.stringify(laporanData));
                
                addLog('‚úÖ Laporan PDF berhasil diperbaiki', 'success');
                showStatus('laporanStatus', '‚úÖ Laporan PDF berhasil diperbaiki! Fungsi cetak/simpan sekarang berfungsi.', 'success');
                
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
                showStatus('laporanStatus', `‚ùå Gagal memperbaiki laporan PDF: ${error.message}`, 'error');
            }
        }

        // Fungsi 4: Force LocalStorage Mode
        function forceLocalStorageMode() {
            addLog('üîí Memaksa aplikasi menggunakan localStorage mode...', 'warning');
            
            try {
                // Set semua flag untuk localStorage mode
                localStorage.setItem('FORCE_LOCALSTORAGE_MODE', 'true');
                localStorage.setItem('DISABLE_ALL_API_CALLS', 'true');
                localStorage.setItem('SERVER_ACTIVE_OVERRIDE', 'true');
                localStorage.setItem('USE_OFFLINE_MODE', 'true');
                
                // Disable semua query ke server
                localStorage.setItem('react_query_disabled', 'true');
                
                // Set data dengan force flag
                const forceData = {
                    profile: { ...dataWawanServerAktif, forceMode: true },
                    supervisions: dataSupervisiServerAktif.map(s => ({ ...s, forceMode: true })),
                    tasks: dataTugasTambahanServerAktif.map(t => ({ ...t, forceMode: true }))
                };
                
                Object.keys(forceData).forEach(key => {
                    localStorage.setItem(`force_${key}`, JSON.stringify(forceData[key]));
                });
                
                addLog('‚úÖ LocalStorage mode berhasil dipaksa', 'success');
                showStatus('localStorageStatus', '‚úÖ LocalStorage mode berhasil dipaksa! Aplikasi sekarang menggunakan data lokal saja.', 'success');
                
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
                showStatus('localStorageStatus', `‚ùå Gagal memaksa localStorage mode: ${error.message}`, 'error');
            }
        }

        // Fungsi 5: Fix Semua Masalah Server Aktif
        function fixSemuaMasalahServerAktif() {
            addLog('üöÄ Memulai perbaikan SEMUA masalah server aktif...', 'info');
            showStatus('mainStatus', '‚è≥ Sedang memperbaiki semua masalah...', 'info');

            try {
                // Jalankan semua fix
                fixDataPersistence();
                setTimeout(() => fixAPIConflicts(), 1000);
                setTimeout(() => fixLaporanPDF(), 2000);
                setTimeout(() => forceLocalStorageMode(), 3000);

                // Set flag global
                setTimeout(() => {
                    localStorage.setItem('server_active_fixed', 'true');
                    localStorage.setItem('server_active_fixed_timestamp', new Date().toISOString());
                    
                    addLog('üéâ SEMUA MASALAH SERVER AKTIF BERHASIL DIPERBAIKI!', 'success');
                    showStatus('mainStatus', 'üéâ SEMUA MASALAH SERVER AKTIF BERHASIL DIPERBAIKI! Aplikasi sekarang berfungsi normal meskipun server aktif. Refresh halaman untuk melihat perubahan.', 'success');
                }, 4000);

            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
                showStatus('mainStatus', `‚ùå Gagal memperbaiki semua masalah: ${error.message}`, 'error');
            }
        }

        // Fungsi 6: Emergency Data Restore
        function emergencyDataRestore() {
            addLog('üö® Memulai emergency data restore...', 'warning');
            
            try {
                // Clear semua data yang mungkin corrupt
                const keysToClean = [
                    'user_data', 'profile_data', 'supervisions_data', 'additional_tasks_data',
                    'schools_data', 'tasks_data', 'app_users'
                ];
                
                keysToClean.forEach(key => {
                    localStorage.removeItem(key);
                });
                
                // Restore dengan data fresh
                setTimeout(() => {
                    fixSemuaMasalahServerAktif();
                }, 1000);
                
                addLog('‚úÖ Emergency restore berhasil', 'success');
                showStatus('emergencyStatus', '‚úÖ Emergency restore berhasil! Data telah dikembalikan.', 'success');
                
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
                showStatus('emergencyStatus', `‚ùå Gagal emergency restore: ${error.message}`, 'error');
            }
        }

        // Fungsi 7: Reset All Settings
        function resetAllSettings() {
            addLog('üîÑ Memulai reset semua settings...', 'warning');
            
            try {
                // Clear localStorage
                localStorage.clear();
                
                // Restore data setelah clear
                setTimeout(() => {
                    fixSemuaMasalahServerAktif();
                }, 2000);
                
                addLog('‚úÖ Reset settings berhasil', 'success');
                showStatus('emergencyStatus', '‚úÖ Reset settings berhasil! Semua data telah direset dan dikembalikan.', 'success');
                
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
                showStatus('emergencyStatus', `‚ùå Gagal reset settings: ${error.message}`, 'error');
            }
        }

        // Fungsi 8: Test Semua Data Server Aktif
        function testSemuaDataServerAktif() {
            addLog('üß™ Memulai test data saat server aktif...', 'info');
            
            let testResults = [];
            let passCount = 0;
            let totalTests = 0;

            // Test 1: Data Persistence
            totalTests++;
            const forceMode = localStorage.getItem('FORCE_LOCALSTORAGE_MODE');
            if (forceMode === 'true') {
                testResults.push('‚úÖ Force LocalStorage Mode: Aktif');
                passCount++;
            } else {
                testResults.push('‚ùå Force LocalStorage Mode: Tidak aktif');
            }

            // Test 2: API Conflicts
            totalTests++;
            const apiDisabled = localStorage.getItem('DISABLE_ALL_API_CALLS');
            if (apiDisabled === 'true') {
                testResults.push('‚úÖ API Conflicts: Teratasi');
                passCount++;
            } else {
                testResults.push('‚ùå API Conflicts: Masih ada');
            }

            // Test 3: Data Wawan
            totalTests++;
            const userData = localStorage.getItem('user_data');
            if (userData) {
                const user = JSON.parse(userData);
                if (user.fullName && user.nip && user.photoUrl) {
                    testResults.push('‚úÖ Data Wawan: Lengkap dan tersedia');
                    passCount++;
                } else {
                    testResults.push('‚ùå Data Wawan: Tidak lengkap');
                }
            } else {
                testResults.push('‚ùå Data Wawan: Tidak ditemukan');
            }

            // Test 4: Data Admin
            totalTests++;
            const supervisions = localStorage.getItem('supervisions_data');
            const tasks = localStorage.getItem('additional_tasks_data');
            if (supervisions && tasks) {
                const sData = JSON.parse(supervisions);
                const tData = JSON.parse(tasks);
                if (sData.length > 0 && tData.length > 0) {
                    testResults.push(`‚úÖ Data Admin: ${sData.length} supervisi, ${tData.length} tugas`);
                    passCount++;
                } else {
                    testResults.push('‚ùå Data Admin: Data kosong');
                }
            } else {
                testResults.push('‚ùå Data Admin: Tidak ditemukan');
            }

            // Test 5: PDF Export
            totalTests++;
            const pdfEnabled = localStorage.getItem('pdf_export_enabled');
            if (pdfEnabled === 'true') {
                testResults.push('‚úÖ PDF Export: Berfungsi');
                passCount++;
            } else {
                testResults.push('‚ùå PDF Export: Tidak berfungsi');
            }

            // Tampilkan hasil test
            const percentage = Math.round((passCount / totalTests) * 100);
            let resultHtml = `
                <div class="status ${percentage === 100 ? 'success' : percentage >= 80 ? 'info' : percentage >= 60 ? 'warning' : 'error'}">
                    <h3>üìä Hasil Test Server Aktif: ${passCount}/${totalTests} (${percentage}%)</h3>
                    <ul style="margin-top: 10px; padding-left: 20px;">
                        ${testResults.map(result => `<li>${result}</li>`).join('')}
                    </ul>
                    ${percentage === 100 ? 
                        '<p style="margin-top: 15px; font-weight: bold; color: #155724;">üéâ Semua test berhasil! Aplikasi siap digunakan dengan server aktif.</p>' : 
                        percentage >= 80 ?
                        '<p style="margin-top: 15px; font-weight: bold; color: #0c5460;">‚ö†Ô∏è Sebagian besar test berhasil. Aplikasi dapat digunakan.</p>' :
                        '<p style="margin-top: 15px; font-weight: bold; color: #721c24;">‚ùå Banyak test gagal. Perlu perbaikan lebih lanjut.</p>'
                    }
                </div>
            `;
            
            document.getElementById('testResults').innerHTML = resultHtml;
            addLog(`üß™ Test selesai: ${passCount}/${totalTests} berhasil (${percentage}%)`, percentage >= 80 ? 'success' : 'warning');
        }

        // Auto-load saat halaman dibuka
        window.addEventListener('load', () => {
            addLog('‚úÖ Halaman siap digunakan', 'success');
            addLog('üí° Klik "FIX SEMUA MASALAH SERVER AKTIF" untuk memperbaiki semua masalah', 'info');
            
            // Auto test data saat ini
            setTimeout(testSemuaDataServerAktif, 1000);
        });
    </script>
</body>
</html>