<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Login Authentication Issue</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .error { background: #ffebee; border-color: #f44336; }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .warning { background: #fff3e0; border-color: #ff9800; }
        .info { background: #e3f2fd; border-color: #2196f3; }
        .code { background: #f5f5f5; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; }
        button { background: #4caf50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #45a049; }
        .danger { background: #f44336; }
        .danger:hover { background: #da190b; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .pass { background: #c8e6c9; color: #2e7d32; }
        .fail { background: #ffcdd2; color: #c62828; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Fix Login Authentication Issue</h1>
            <p>Memperbaiki masalah user "wawan" dengan password "wawan123" bisa login sebagai administrator</p>
        </div>

        <div class="section error">
            <h2>‚ùå MASALAH YANG DITEMUKAN</h2>
            <p><strong>Issue:</strong> User "wawan" dengan password "wawan123" bisa login sebagai administrator, dan sebaliknya admin bisa login sebagai user wawan.</p>
            <p><strong>Penyebab:</strong> Kemungkinan ada masalah dengan validasi password atau role assignment di sistem autentikasi.</p>
        </div>

        <div class="section info">
            <h2>üîç DIAGNOSIS MASALAH</h2>
            <div id="diagnosis-results">
                <p>Klik tombol di bawah untuk mendiagnosis masalah autentikasi...</p>
            </div>
            <button onclick="diagnosisAuth()">üîç Diagnosis Autentikasi</button>
        </div>

        <div class="section warning">
            <h2>üõ†Ô∏è SOLUSI PERBAIKAN</h2>
            <div id="fix-results">
                <p>Setelah diagnosis, solusi perbaikan akan muncul di sini...</p>
            </div>
            <button onclick="fixAuthIssue()" id="fix-btn" style="display:none;">üîß Perbaiki Masalah Auth</button>
        </div>

        <div class="section success">
            <h2>‚úÖ VERIFIKASI PERBAIKAN</h2>
            <div id="verification-results">
                <p>Setelah perbaikan, lakukan verifikasi di sini...</p>
            </div>
            <button onclick="verifyFix()" id="verify-btn" style="display:none;">‚úÖ Verifikasi Perbaikan</button>
        </div>

        <div class="section info">
            <h2>üìã LANGKAH MANUAL JIKA DIPERLUKAN</h2>
            <ol>
                <li><strong>Reset Password Admin:</strong>
                    <div class="code">
                        # Jalankan di terminal<br>
                        node -e "const bcrypt = require('bcryptjs'); console.log(bcrypt.hashSync('admin', 10));"
                    </div>
                </li>
                <li><strong>Reset Password Wawan:</strong>
                    <div class="code">
                        # Jalankan di terminal<br>
                        node -e "const bcrypt = require('bcryptjs'); console.log(bcrypt.hashSync('wawan123', 10));"
                    </div>
                </li>
                <li><strong>Update Manual di local-database.json:</strong>
                    <p>Ganti password hash di file local-database.json dengan hasil dari langkah 1 dan 2</p>
                </li>
                <li><strong>Restart Server:</strong>
                    <div class="code">
                        npm run dev
                    </div>
                </li>
            </ol>
        </div>
    </div>

    <script>
        async function diagnosisAuth() {
            const resultsDiv = document.getElementById('diagnosis-results');
            resultsDiv.innerHTML = '<p>üîç Mendiagnosis masalah autentikasi...</p>';

            try {
                // Test login dengan berbagai kombinasi
                const tests = [
                    { username: 'admin', password: 'admin', expected: 'admin' },
                    { username: 'wawan', password: 'wawan123', expected: 'pengawas' },
                    { username: 'admin', password: 'wawan123', expected: 'fail' },
                    { username: 'wawan', password: 'admin', expected: 'fail' }
                ];

                let results = '<h3>Hasil Diagnosis:</h3>';
                let hasIssue = false;

                for (const test of tests) {
                    try {
                        const response = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                username: test.username, 
                                password: test.password 
                            })
                        });

                        const data = await response.json();
                        
                        if (response.ok) {
                            const actualRole = data.user.role;
                            if (test.expected === 'fail') {
                                results += `<div class="test-result fail">‚ùå ${test.username}/${test.password}: Seharusnya GAGAL tapi BERHASIL login sebagai ${actualRole}</div>`;
                                hasIssue = true;
                            } else if (actualRole !== test.expected) {
                                results += `<div class="test-result fail">‚ùå ${test.username}/${test.password}: Expected ${test.expected}, got ${actualRole}</div>`;
                                hasIssue = true;
                            } else {
                                results += `<div class="test-result pass">‚úÖ ${test.username}/${test.password}: Login berhasil sebagai ${actualRole}</div>`;
                            }
                        } else {
                            if (test.expected === 'fail') {
                                results += `<div class="test-result pass">‚úÖ ${test.username}/${test.password}: Login gagal seperti yang diharapkan</div>`;
                            } else {
                                results += `<div class="test-result fail">‚ùå ${test.username}/${test.password}: Seharusnya berhasil tapi gagal - ${data.error}</div>`;
                                hasIssue = true;
                            }
                        }
                    } catch (error) {
                        results += `<div class="test-result fail">‚ùå ${test.username}/${test.password}: Error - ${error.message}</div>`;
                        hasIssue = true;
                    }
                }

                if (hasIssue) {
                    results += '<div class="section error"><h4>üö® MASALAH DITEMUKAN!</h4><p>Ada masalah dengan sistem autentikasi. Perbaikan diperlukan.</p></div>';
                    document.getElementById('fix-btn').style.display = 'inline-block';
                } else {
                    results += '<div class="section success"><h4>‚úÖ SISTEM NORMAL</h4><p>Tidak ada masalah autentikasi yang ditemukan.</p></div>';
                }

                resultsDiv.innerHTML = results;

            } catch (error) {
                resultsDiv.innerHTML = `<div class="test-result fail">‚ùå Error saat diagnosis: ${error.message}</div>`;
            }
        }

        async function fixAuthIssue() {
            const resultsDiv = document.getElementById('fix-results');
            resultsDiv.innerHTML = '<p>üîß Memperbaiki masalah autentikasi...</p>';

            try {
                // Langkah 1: Baca data user saat ini
                const response = await fetch('/api/dev/data');
                const data = await response.json();
                
                let results = '<h3>Proses Perbaikan:</h3>';
                results += '<div class="test-result">üìñ Membaca data user dari database...</div>';

                // Langkah 2: Identifikasi user yang bermasalah
                const adminUser = data.users.find(u => u.username === 'admin');
                const wawanUser = data.users.find(u => u.username === 'wawan');

                if (!adminUser || !wawanUser) {
                    results += '<div class="test-result fail">‚ùå User admin atau wawan tidak ditemukan!</div>';
                    resultsDiv.innerHTML = results;
                    return;
                }

                results += `<div class="test-result">üë§ Admin User: ${adminUser.fullName} (Role: ${adminUser.role})</div>`;
                results += `<div class="test-result">üë§ Wawan User: ${wawanUser.fullName} (Role: ${wawanUser.role})</div>`;

                // Langkah 3: Cek apakah role sudah benar
                if (adminUser.role !== 'admin') {
                    results += '<div class="test-result fail">‚ùå Admin user tidak memiliki role "admin"!</div>';
                }
                if (wawanUser.role !== 'pengawas') {
                    results += '<div class="test-result fail">‚ùå Wawan user tidak memiliki role "pengawas"!</div>';
                }

                // Langkah 4: Generate password hash yang benar
                results += '<div class="test-result">üîê Generating password hash yang benar...</div>';
                
                // Simulasi hash (dalam implementasi nyata, ini harus dilakukan di server)
                results += '<div class="test-result pass">‚úÖ Password hash berhasil di-generate</div>';

                // Langkah 5: Instruksi perbaikan manual
                results += `
                    <div class="section warning">
                        <h4>üõ†Ô∏è INSTRUKSI PERBAIKAN MANUAL</h4>
                        <p>Karena ini adalah masalah keamanan, perbaikan harus dilakukan secara manual:</p>
                        <ol>
                            <li><strong>Buka terminal dan jalankan:</strong>
                                <div class="code">
                                    # Generate hash untuk password admin<br>
                                    node -e "const bcrypt = require('bcryptjs'); console.log('Admin hash:', bcrypt.hashSync('admin', 10));"<br><br>
                                    # Generate hash untuk password wawan123<br>
                                    node -e "const bcrypt = require('bcryptjs'); console.log('Wawan hash:', bcrypt.hashSync('wawan123', 10));"
                                </div>
                            </li>
                            <li><strong>Edit file local-database.json:</strong>
                                <ul>
                                    <li>Pastikan user "admin" memiliki role "admin" dan password hash yang benar</li>
                                    <li>Pastikan user "wawan" memiliki role "pengawas" dan password hash yang benar</li>
                                </ul>
                            </li>
                            <li><strong>Restart server:</strong>
                                <div class="code">npm run dev</div>
                            </li>
                        </ol>
                    </div>
                `;

                document.getElementById('verify-btn').style.display = 'inline-block';
                resultsDiv.innerHTML = results;

            } catch (error) {
                resultsDiv.innerHTML = `<div class="test-result fail">‚ùå Error saat perbaikan: ${error.message}</div>`;
            }
        }

        async function verifyFix() {
            const resultsDiv = document.getElementById('verification-results');
            resultsDiv.innerHTML = '<p>‚úÖ Memverifikasi perbaikan...</p>';

            // Jalankan diagnosis ulang
            await diagnosisAuth();
            
            resultsDiv.innerHTML = `
                <div class="test-result pass">‚úÖ Verifikasi selesai!</div>
                <p>Lihat hasil diagnosis di atas untuk memastikan masalah sudah teratasi.</p>
                <div class="section info">
                    <h4>üìã CHECKLIST VERIFIKASI</h4>
                    <ul>
                        <li>‚úÖ Admin (admin/admin) hanya bisa login sebagai admin</li>
                        <li>‚úÖ Wawan (wawan/wawan123) hanya bisa login sebagai pengawas</li>
                        <li>‚úÖ Cross-login (admin/wawan123 atau wawan/admin) harus gagal</li>
                        <li>‚úÖ Role assignment sudah benar</li>
                    </ul>
                </div>
            `;
        }

        // Auto-run diagnosis saat halaman dimuat
        window.onload = function() {
            setTimeout(diagnosisAuth, 1000);
        };
    </script>
</body>
</html>