<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Supabase API - Final</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .alert { padding: 15px; margin: 15px 0; border-radius: 5px; }
        .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .alert-info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .alert-warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .step { background: #f8f9fa; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #007bff; }
        .code { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 14px; overflow-x: auto; margin: 10px 0; }
        .btn { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; font-size: 14px; }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        h1 { color: #28a745; text-align: center; }
        h2 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        h3 { color: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úÖ SETUP SUPABASE API - FINAL</h1>

        <div class="alert alert-success">
            <strong>üéâ API SUDAH DIPERBAIKI!</strong>
            <p>Saya telah memperbaiki semua API endpoints agar data bisa tersimpan ke Supabase dengan benar:</p>
            <ul>
                <li>‚úÖ <code>/api/activities.js</code> - Sekarang menyimpan ke Supabase</li>
                <li>‚úÖ <code>/api/supervisions.js</code> - Sekarang menyimpan ke Supabase</li>
                <li>‚úÖ <code>/api/tasks.js</code> - Sekarang menyimpan ke Supabase</li>
            </ul>
        </div>

        <!-- STEP 1: HAPUS DATA DUMMY -->
        <div class="step">
            <h3>üóëÔ∏è STEP 1: HAPUS DATA DUMMY DARI SUPABASE</h3>
            <p>Pertama, kita perlu menghapus data dummy yang ada di Supabase:</p>
            
            <div class="alert alert-warning">
                <strong>‚ö†Ô∏è PERINGATAN:</strong> Script ini akan menghapus SEMUA data dummy di Supabase. 
                Pastikan Anda sudah backup data penting!
            </div>
            
            <div class="code">
// SCRIPT HAPUS DATA DUMMY DARI SUPABASE
console.log('üóëÔ∏è Menghapus data dummy dari Supabase...');

async function hapusDataDummySupabase() {
    const konfirmasi = confirm('‚ö†Ô∏è PERINGATAN!\n\nScript ini akan menghapus SEMUA data dummy di Supabase.\nApakah Anda yakin ingin melanjutkan?');
    
    if (!konfirmasi) {
        console.log('‚ùå Operasi dibatalkan oleh user');
        return;
    }
    
    try {
        // Hapus data dari tabel additional_tasks
        console.log('üóëÔ∏è Menghapus data dari tabel additional_tasks...');
        const tasksResponse = await fetch('/api/tasks', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (tasksResponse.ok) {
            console.log('‚úÖ Data dummy tasks berhasil dihapus');
        } else {
            console.log('‚ö†Ô∏è Tidak bisa hapus tasks (mungkin sudah kosong)');
        }
        
        // Hapus data dari tabel supervisions
        console.log('üóëÔ∏è Menghapus data dari tabel supervisions...');
        const supervisionsResponse = await fetch('/api/supervisions', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (supervisionsResponse.ok) {
            console.log('‚úÖ Data dummy supervisions berhasil dihapus');
        } else {
            console.log('‚ö†Ô∏è Tidak bisa hapus supervisions (mungkin sudah kosong)');
        }
        
        // Hapus data dari tabel activities/events
        console.log('üóëÔ∏è Menghapus data dari tabel activities...');
        const activitiesResponse = await fetch('/api/activities', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (activitiesResponse.ok) {
            console.log('‚úÖ Data dummy activities berhasil dihapus');
        } else {
            console.log('‚ö†Ô∏è Tidak bisa hapus activities (mungkin sudah kosong)');
        }
        
        console.log('üéâ Proses hapus data dummy selesai!');
        alert('‚úÖ Data dummy berhasil dihapus!\nSekarang Anda bisa input data real.');
        
    } catch (error) {
        console.error('‚ùå Error hapus data dummy:', error);
        alert('‚ùå Error: ' + error.message);
    }
}

// Jalankan fungsi hapus data dummy
hapusDataDummySupabase();
            </div>
            
            <button class="btn btn-danger" onclick="copyScript('hapus')">Copy Script Hapus Data Dummy</button>
        </div>

        <!-- STEP 2: TEST API BARU -->
        <div class="step">
            <h3>‚ö° STEP 2: TEST API YANG SUDAH DIPERBAIKI</h3>
            <p>Test apakah API sudah bisa menyimpan data ke Supabase:</p>
            
            <div class="code">
// SCRIPT TEST API YANG SUDAH DIPERBAIKI
console.log('‚ö° Testing API yang sudah diperbaiki...');

async function testAPIBaru() {
    try {
        // Test API Activities
        console.log('üìã Testing API Activities...');
        const testActivity = {
            title: 'TEST AKTIVITAS REAL - ' + new Date().toLocaleString(),
            description: 'Ini adalah test aktivitas real ke Supabase',
            date: new Date().toISOString().split('T')[0],
            user_id: 'test_user',
            type: 'test',
            location: 'Test Location'
        };
        
        const activityResponse = await fetch('/api/activities', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(testActivity)
        });
        
        if (activityResponse.ok) {
            const activityResult = await activityResponse.json();
            console.log('‚úÖ API Activities berhasil:', activityResult);
        } else {
            console.log('‚ùå API Activities gagal:', activityResponse.status);
        }
        
        // Test API Supervisions
        console.log('üè´ Testing API Supervisions...');
        const testSupervision = {
            school_name: 'TEST SEKOLAH - ' + new Date().toLocaleString(),
            type: 'Akademik',
            date: new Date().toISOString().split('T')[0],
            findings: 'Ini adalah test supervisi real ke Supabase',
            recommendations: 'Test rekomendasi',
            user_id: 'test_user'
        };
        
        const supervisionResponse = await fetch('/api/supervisions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(testSupervision)
        });
        
        if (supervisionResponse.ok) {
            const supervisionResult = await supervisionResponse.json();
            console.log('‚úÖ API Supervisions berhasil:', supervisionResult);
        } else {
            console.log('‚ùå API Supervisions gagal:', supervisionResponse.status);
        }
        
        // Test API Tasks
        console.log('üìù Testing API Tasks...');
        const testTask = {
            title: 'TEST TUGAS REAL - ' + new Date().toLocaleString(),
            description: 'Ini adalah test tugas real ke Supabase',
            date: new Date().toISOString().split('T')[0],
            user_id: 'test_user',
            status: 'pending',
            location: 'Test Location'
        };
        
        const taskResponse = await fetch('/api/tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(testTask)
        });
        
        if (taskResponse.ok) {
            const taskResult = await taskResponse.json();
            console.log('‚úÖ API Tasks berhasil:', taskResult);
        } else {
            console.log('‚ùå API Tasks gagal:', taskResponse.status);
        }
        
        console.log('üéâ Test API selesai! Cek Supabase Dashboard untuk melihat data test.');
        alert('‚úÖ Test API berhasil!\nCek Supabase Dashboard untuk melihat data test yang baru disimpan.');
        
    } catch (error) {
        console.error('‚ùå Error test API:', error);
        alert('‚ùå Error: ' + error.message);
    }
}

// Jalankan test API
testAPIBaru();
            </div>
            
            <button class="btn btn-success" onclick="copyScript('test')">Copy Script Test API</button>
        </div>

        <!-- STEP 3: INPUT DATA REAL -->
        <div class="step">
            <h3>üìù STEP 3: INPUT DATA REAL ANDA</h3>
            <p>Sekarang input data real Anda menggunakan API yang sudah diperbaiki:</p>
            
            <div class="code">
// SCRIPT INPUT DATA REAL ANDA
console.log('üìù Input data real Anda...');

async function inputDataReal() {
    // Pastikan user sudah login
    const authUser = localStorage.getItem('auth_user');
    if (!authUser) {
        alert('‚ùå Silakan login terlebih dahulu!');
        return;
    }
    
    const userData = JSON.parse(authUser);
    console.log('üë§ User aktif:', userData.username);
    
    // GANTI DATA DI BAWAH INI DENGAN DATA REAL ANDA!
    const dataReal = {
        activities: [
            {
                title: 'GANTI: Aktivitas Real Anda 1',
                description: 'GANTI: Deskripsi aktivitas real Anda',
                date: '2024-12-21',
                user_id: userData.id || 'current_user',
                type: 'supervisi',
                location: 'GANTI: Lokasi aktivitas'
            },
            {
                title: 'GANTI: Aktivitas Real Anda 2',
                description: 'GANTI: Deskripsi aktivitas real Anda',
                date: '2024-12-20',
                user_id: userData.id || 'current_user',
                type: 'pelatihan',
                location: 'GANTI: Lokasi aktivitas'
            }
        ],
        supervisions: [
            {
                school_name: 'GANTI: Nama Sekolah Real',
                type: 'Akademik',
                date: '2024-12-21',
                findings: 'GANTI: Temuan supervisi real',
                recommendations: 'GANTI: Rekomendasi real',
                user_id: userData.id || 'current_user'
            }
        ],
        tasks: [
            {
                title: 'GANTI: Tugas Real Anda',
                description: 'GANTI: Deskripsi tugas real',
                date: '2024-12-21',
                status: 'pending',
                user_id: userData.id || 'current_user',
                location: 'GANTI: Lokasi tugas'
            }
        ]
    };
    
    let successCount = 0;
    let errorCount = 0;
    
    // Input Activities
    for (const activity of dataReal.activities) {
        try {
            const response = await fetch('/api/activities', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(activity)
            });
            
            if (response.ok) {
                console.log('‚úÖ Activity berhasil:', activity.title);
                successCount++;
            } else {
                console.log('‚ùå Activity gagal:', activity.title);
                errorCount++;
            }
        } catch (error) {
            console.error('‚ùå Error activity:', error);
            errorCount++;
        }
        
        await new Promise(resolve => setTimeout(resolve, 1000)); // Delay 1 detik
    }
    
    // Input Supervisions
    for (const supervision of dataReal.supervisions) {
        try {
            const response = await fetch('/api/supervisions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(supervision)
            });
            
            if (response.ok) {
                console.log('‚úÖ Supervision berhasil:', supervision.school_name);
                successCount++;
            } else {
                console.log('‚ùå Supervision gagal:', supervision.school_name);
                errorCount++;
            }
        } catch (error) {
            console.error('‚ùå Error supervision:', error);
            errorCount++;
        }
        
        await new Promise(resolve => setTimeout(resolve, 1000)); // Delay 1 detik
    }
    
    // Input Tasks
    for (const task of dataReal.tasks) {
        try {
            const response = await fetch('/api/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(task)
            });
            
            if (response.ok) {
                console.log('‚úÖ Task berhasil:', task.title);
                successCount++;
            } else {
                console.log('‚ùå Task gagal:', task.title);
                errorCount++;
            }
        } catch (error) {
            console.error('‚ùå Error task:', error);
            errorCount++;
        }
        
        await new Promise(resolve => setTimeout(resolve, 1000)); // Delay 1 detik
    }
    
    console.log('üéâ INPUT DATA SELESAI!');
    console.log(`‚úÖ Berhasil: ${successCount} data`);
    console.log(`‚ùå Gagal: ${errorCount} data`);
    
    if (successCount > 0) {
        alert(`‚úÖ Berhasil input ${successCount} data real ke Supabase!\n\nCek Supabase Dashboard untuk melihat data Anda.\nRefresh aplikasi untuk melihat perubahan.`);
        setTimeout(() => location.reload(), 3000);
    } else {
        alert('‚ùå Tidak ada data yang berhasil disimpan. Cek console untuk detail error.');
    }
}

// Jalankan input data real
inputDataReal();
            </div>
            
            <button class="btn btn-success" onclick="copyScript('input')">Copy Script Input Data Real</button>
        </div>

        <!-- STEP 4: VERIFIKASI -->
        <div class="step">
            <h3>‚úÖ STEP 4: VERIFIKASI HASIL</h3>
            <p>Verifikasi apakah data sudah tersimpan dengan benar:</p>
            
            <div class="alert alert-info">
                <strong>üìã CHECKLIST VERIFIKASI:</strong>
                <ul>
                    <li>‚úÖ Buka Supabase Dashboard</li>
                    <li>‚úÖ Cek tabel: additional_tasks, supervisions, activities/events</li>
                    <li>‚úÖ Pastikan data yang muncul adalah data real Anda</li>
                    <li>‚úÖ Refresh aplikasi dan cek apakah data muncul</li>
                    <li>‚úÖ Test input data baru dari aplikasi</li>
                </ul>
            </div>
            
            <button class="btn btn-success" onclick="window.open('https://sistem-informasi-pengawas-cd11.netlify.app/', '_blank')">Buka Aplikasi</button>
            <button class="btn btn-success" onclick="window.open('https://supabase.com/dashboard', '_blank')">Buka Supabase Dashboard</button>
        </div>

        <!-- INSTRUKSI PENGGUNAAN -->
        <div class="alert alert-success">
            <h3>üìñ CARA MENGGUNAKAN:</h3>
            <ol>
                <li><strong>Login</strong> ke aplikasi terlebih dahulu</li>
                <li><strong>Buka Console (F12)</strong> di browser</li>
                <li><strong>Jalankan Step 1:</strong> Hapus data dummy</li>
                <li><strong>Jalankan Step 2:</strong> Test API baru</li>
                <li><strong>Edit Step 3:</strong> Ganti dengan data real Anda</li>
                <li><strong>Jalankan Step 3:</strong> Input data real</li>
                <li><strong>Verifikasi:</strong> Cek Supabase dan aplikasi</li>
            </ol>
        </div>

        <!-- PERUBAHAN YANG DILAKUKAN -->
        <div class="alert alert-info">
            <h3>üîß PERUBAHAN YANG SUDAH DILAKUKAN:</h3>
            <ul>
                <li><strong>API Activities:</strong> Sekarang menyimpan ke tabel 'activities' atau 'events' di Supabase</li>
                <li><strong>API Supervisions:</strong> Sekarang menyimpan ke tabel 'supervisions' di Supabase</li>
                <li><strong>API Tasks:</strong> Sekarang menyimpan ke tabel 'additional_tasks' di Supabase</li>
                <li><strong>Error Handling:</strong> Ditambahkan error handling yang lebih baik</li>
                <li><strong>Data Mapping:</strong> Field data disesuaikan dengan struktur tabel Supabase</li>
            </ul>
        </div>
    </div>

    <script>
        function copyScript(type) {
            const scripts = {
                hapus: `// SCRIPT HAPUS DATA DUMMY DARI SUPABASE
console.log('üóëÔ∏è Menghapus data dummy dari Supabase...');

async function hapusDataDummySupabase() {
    const konfirmasi = confirm('‚ö†Ô∏è PERINGATAN!\\n\\nScript ini akan menghapus SEMUA data dummy di Supabase.\\nApakah Anda yakin ingin melanjutkan?');
    
    if (!konfirmasi) {
        console.log('‚ùå Operasi dibatalkan oleh user');
        return;
    }
    
    try {
        console.log('üóëÔ∏è Menghapus data dari tabel additional_tasks...');
        const tasksResponse = await fetch('/api/tasks', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (tasksResponse.ok) {
            console.log('‚úÖ Data dummy tasks berhasil dihapus');
        }
        
        console.log('üóëÔ∏è Menghapus data dari tabel supervisions...');
        const supervisionsResponse = await fetch('/api/supervisions', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (supervisionsResponse.ok) {
            console.log('‚úÖ Data dummy supervisions berhasil dihapus');
        }
        
        console.log('üóëÔ∏è Menghapus data dari tabel activities...');
        const activitiesResponse = await fetch('/api/activities', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (activitiesResponse.ok) {
            console.log('‚úÖ Data dummy activities berhasil dihapus');
        }
        
        console.log('üéâ Proses hapus data dummy selesai!');
        alert('‚úÖ Data dummy berhasil dihapus!\\nSekarang Anda bisa input data real.');
        
    } catch (error) {
        console.error('‚ùå Error hapus data dummy:', error);
        alert('‚ùå Error: ' + error.message);
    }
}

hapusDataDummySupabase();`,

                test: `// SCRIPT TEST API YANG SUDAH DIPERBAIKI
console.log('‚ö° Testing API yang sudah diperbaiki...');

async function testAPIBaru() {
    try {
        const testActivity = {
            title: 'TEST AKTIVITAS REAL - ' + new Date().toLocaleString(),
            description: 'Ini adalah test aktivitas real ke Supabase',
            date: new Date().toISOString().split('T')[0],
            user_id: 'test_user',
            type: 'test',
            location: 'Test Location'
        };
        
        const activityResponse = await fetch('/api/activities', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(testActivity)
        });
        
        if (activityResponse.ok) {
            const activityResult = await activityResponse.json();
            console.log('‚úÖ API Activities berhasil:', activityResult);
        } else {
            console.log('‚ùå API Activities gagal:', activityResponse.status);
        }
        
        const testSupervision = {
            school_name: 'TEST SEKOLAH - ' + new Date().toLocaleString(),
            type: 'Akademik',
            date: new Date().toISOString().split('T')[0],
            findings: 'Ini adalah test supervisi real ke Supabase',
            recommendations: 'Test rekomendasi',
            user_id: 'test_user'
        };
        
        const supervisionResponse = await fetch('/api/supervisions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(testSupervision)
        });
        
        if (supervisionResponse.ok) {
            const supervisionResult = await supervisionResponse.json();
            console.log('‚úÖ API Supervisions berhasil:', supervisionResult);
        } else {
            console.log('‚ùå API Supervisions gagal:', supervisionResponse.status);
        }
        
        const testTask = {
            title: 'TEST TUGAS REAL - ' + new Date().toLocaleString(),
            description: 'Ini adalah test tugas real ke Supabase',
            date: new Date().toISOString().split('T')[0],
            user_id: 'test_user',
            status: 'pending',
            location: 'Test Location'
        };
        
        const taskResponse = await fetch('/api/tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(testTask)
        });
        
        if (taskResponse.ok) {
            const taskResult = await taskResponse.json();
            console.log('‚úÖ API Tasks berhasil:', taskResult);
        } else {
            console.log('‚ùå API Tasks gagal:', taskResponse.status);
        }
        
        console.log('üéâ Test API selesai! Cek Supabase Dashboard untuk melihat data test.');
        alert('‚úÖ Test API berhasil!\\nCek Supabase Dashboard untuk melihat data test yang baru disimpan.');
        
    } catch (error) {
        console.error('‚ùå Error test API:', error);
        alert('‚ùå Error: ' + error.message);
    }
}

testAPIBaru();`,

                input: `// SCRIPT INPUT DATA REAL ANDA - GANTI DATA DI BAWAH!
console.log('üìù Input data real Anda...');

async function inputDataReal() {
    const authUser = localStorage.getItem('auth_user');
    if (!authUser) {
        alert('‚ùå Silakan login terlebih dahulu!');
        return;
    }
    
    const userData = JSON.parse(authUser);
    console.log('üë§ User aktif:', userData.username);
    
    // GANTI DATA DI BAWAH INI DENGAN DATA REAL ANDA!
    const dataReal = {
        activities: [
            {
                title: 'GANTI: Aktivitas Real Anda 1',
                description: 'GANTI: Deskripsi aktivitas real Anda',
                date: '2024-12-21',
                user_id: userData.id || 'current_user',
                type: 'supervisi',
                location: 'GANTI: Lokasi aktivitas'
            }
        ],
        supervisions: [
            {
                school_name: 'GANTI: Nama Sekolah Real',
                type: 'Akademik',
                date: '2024-12-21',
                findings: 'GANTI: Temuan supervisi real',
                recommendations: 'GANTI: Rekomendasi real',
                user_id: userData.id || 'current_user'
            }
        ],
        tasks: [
            {
                title: 'GANTI: Tugas Real Anda',
                description: 'GANTI: Deskripsi tugas real',
                date: '2024-12-21',
                status: 'pending',
                user_id: userData.id || 'current_user',
                location: 'GANTI: Lokasi tugas'
            }
        ]
    };
    
    let successCount = 0;
    let errorCount = 0;
    
    for (const [type, items] of Object.entries(dataReal)) {
        for (const item of items) {
            try {
                const response = await fetch(\`/api/\${type}\`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(item)
                });
                
                if (response.ok) {
                    console.log(\`‚úÖ \${type} berhasil:\`, item.title || item.school_name);
                    successCount++;
                } else {
                    console.log(\`‚ùå \${type} gagal:\`, item.title || item.school_name);
                    errorCount++;
                }
            } catch (error) {
                console.error(\`‚ùå Error \${type}:\`, error);
                errorCount++;
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
    }
    
    console.log('üéâ INPUT DATA SELESAI!');
    console.log(\`‚úÖ Berhasil: \${successCount} data\`);
    console.log(\`‚ùå Gagal: \${errorCount} data\`);
    
    if (successCount > 0) {
        alert(\`‚úÖ Berhasil input \${successCount} data real ke Supabase!\\n\\nCek Supabase Dashboard untuk melihat data Anda.\\nRefresh aplikasi untuk melihat perubahan.\`);
        setTimeout(() => location.reload(), 3000);
    } else {
        alert('‚ùå Tidak ada data yang berhasil disimpan. Cek console untuk detail error.');
    }
}

inputDataReal();`
            };
            
            navigator.clipboard.writeText(scripts[type]).then(() => {
                alert('‚úÖ Script berhasil di-copy! Paste di Console aplikasi (F12).');
            }).catch(() => {
                alert('‚ùå Gagal copy script. Silakan copy manual.');
            });
        }
    </script>
</body>
</html>