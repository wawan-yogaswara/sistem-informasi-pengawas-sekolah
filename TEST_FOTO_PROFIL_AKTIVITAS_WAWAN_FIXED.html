<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Foto Profil & Aktivitas Wawan - FIXED</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .photo-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin: 10px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîß Test Foto Profil & Aktivitas Wawan - FIXED</h1>
    
    <div class="test-section info">
        <h3>üìã Checklist Perbaikan</h3>
        <ul>
            <li>‚úÖ Fix TypeScript errors di dashboard</li>
            <li>‚úÖ Perbaiki loading foto profil dari localStorage</li>
            <li>‚úÖ Enhanced pencarian aktivitas Wawan dengan multiple field matching</li>
            <li>‚úÖ Tambah fallback untuk username fields yang berbeda</li>
            <li>‚úÖ Special case handling untuk user "Wawan"</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>üñºÔ∏è Test Foto Profil Dashboard</h3>
        <button onclick="testPhotoProfile()">Test Load Foto Profil</button>
        <button onclick="setupSampleProfile()">Setup Sample Profile dengan Foto</button>
        <div id="photoResult"></div>
    </div>

    <div class="test-section">
        <h3>üë§ Test Aktivitas User Wawan</h3>
        <button onclick="setupWawanData()">Setup Data Wawan</button>
        <button onclick="testWawanActivities()">Test Load Aktivitas Wawan</button>
        <div id="wawanResult"></div>
    </div>

    <div class="test-section">
        <h3>üîç Debug Info</h3>
        <button onclick="showDebugInfo()">Show Debug Info</button>
        <div id="debugInfo"></div>
    </div>

    <script>
        // Test foto profil
        function testPhotoProfile() {
            console.log('üîÑ Testing photo profile loading...');
            
            // Simulate profile loading logic from dashboard
            const sources = [
                'user_data',
                'profile_data', 
                'current_user',
                'user_profile',
                'profile_info'
            ];
            
            let profile = null;
            for (const source of sources) {
                const data = localStorage.getItem(source);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        if (parsed && (parsed.photoUrl || parsed.fullName || parsed.nip)) {
                            profile = parsed;
                            console.log(`‚úÖ Profile loaded from ${source}:`, profile);
                            break;
                        }
                    } catch (e) {
                        console.warn(`Failed to parse ${source}:`, e);
                    }
                }
            }
            
            const result = document.getElementById('photoResult');
            if (profile && profile.photoUrl) {
                result.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Foto Profil Ditemukan</h4>
                        <p><strong>Nama:</strong> ${profile.fullName}</p>
                        <p><strong>NIP:</strong> ${profile.nip || '-'}</p>
                        <p><strong>Photo URL:</strong> ${profile.photoUrl}</p>
                        <img src="${profile.photoUrl}" alt="Profile" class="photo-preview" 
                             onerror="this.style.display='none'; this.nextSibling.style.display='block';">
                        <div style="display:none; color: red;">‚ùå Foto gagal dimuat</div>
                    </div>
                `;
            } else {
                result.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Foto Profil Tidak Ditemukan</h4>
                        <p>Profile data: ${profile ? JSON.stringify(profile) : 'null'}</p>
                    </div>
                `;
            }
        }

        function setupSampleProfile() {
            const sampleProfile = {
                fullName: 'Wawan Setiawan',
                nip: '196801011990031001',
                photoUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzMzNzNkYyIvPjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+V2F3YW48L3RleHQ+PC9zdmc+',
                role: 'pengawas'
            };
            
            // Save to multiple locations
            localStorage.setItem('user_profile', JSON.stringify(sampleProfile));
            localStorage.setItem('current_user', JSON.stringify(sampleProfile));
            localStorage.setItem('user_data', JSON.stringify(sampleProfile));
            
            alert('‚úÖ Sample profile dengan foto telah disimpan!');
        }

        // Test aktivitas Wawan
        function setupWawanData() {
            const sampleData = {
                tasks: [
                    {
                        id: 'task-1',
                        title: 'Supervisi SMKN 14 Garut',
                        description: 'Supervisi dan pembinaan Kepala SMKN 14 Garut',
                        date: '2025-01-15',
                        completed: true,
                        userId: 'wawan-123',
                        username: 'wawan',
                        category: 'Supervisi Akademik'
                    }
                ],
                supervisions: [
                    {
                        id: 'sup-1',
                        schoolName: 'SMKN 14 Garut',
                        type: 'Supervisi Akademik',
                        findings: 'Pembelajaran sudah sesuai kurikulum merdeka',
                        recommendations: 'Tingkatkan penggunaan teknologi',
                        date: '2025-01-15',
                        userId: 'wawan-123',
                        username: 'wawan'
                    }
                ],
                events: [
                    {
                        id: 'event-1',
                        title: 'Rapat Koordinasi Pengawas',
                        description: 'Rapat koordinasi bulanan pengawas sekolah',
                        date: '2025-01-20',
                        time: '09:00',
                        userId: 'wawan-123',
                        username: 'wawan'
                    }
                ],
                additionalTasks: [
                    {
                        id: 'add-1',
                        name: 'Workshop Kurikulum Merdeka',
                        description: 'Mengikuti workshop implementasi kurikulum merdeka',
                        date: '2025-01-25',
                        organizer: 'Dinas Pendidikan',
                        location: 'Aula Disdik',
                        userId: 'wawan-123',
                        username: 'wawan'
                    }
                ]
            };
            
            localStorage.setItem('local-database', JSON.stringify(sampleData));
            
            // Also save individual keys as fallback
            localStorage.setItem('tasks', JSON.stringify(sampleData.tasks));
            localStorage.setItem('supervisions', JSON.stringify(sampleData.supervisions));
            localStorage.setItem('events', JSON.stringify(sampleData.events));
            localStorage.setItem('additional_tasks', JSON.stringify(sampleData.additionalTasks));
            
            alert('‚úÖ Sample data Wawan telah disimpan!');
        }

        function testWawanActivities() {
            console.log('üîÑ Testing Wawan activities loading...');
            
            const userId = 'wawan-123';
            const userName = 'wawan';
            
            // Simulate the enhanced filtering logic
            const getLocalStorageData = (key) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : [];
                } catch {
                    return [];
                }
            };

            const filterByUser = (data, userField = 'userId') => {
                if (!data || !Array.isArray(data)) {
                    return [];
                }
                
                return data.filter(item => {
                    // Match by userId (exact match)
                    if (item[userField] === userId) {
                        return true;
                    }
                    
                    // Match by username (case insensitive) - check multiple username fields
                    const usernameFields = ['username', 'user', 'createdBy', 'assignedTo'];
                    for (const field of usernameFields) {
                        if (item[field] && userName && 
                            item[field].toLowerCase() === userName.toLowerCase()) {
                            return true;
                        }
                    }
                    
                    // Special case for Wawan - also check if item contains "wawan" in any text field
                    if (userName && userName.toLowerCase() === 'wawan') {
                        const textFields = ['title', 'name', 'description', 'notes', 'findings'];
                        for (const field of textFields) {
                            if (item[field] && typeof item[field] === 'string' && 
                                item[field].toLowerCase().includes('wawan')) {
                                return true;
                            }
                        }
                    }
                    
                    return false;
                });
            };

            const localData = getLocalStorageData('local-database') || {};
            
            const tasks = filterByUser(localData.tasks || getLocalStorageData('tasks'));
            const supervisions = filterByUser(localData.supervisions || getLocalStorageData('supervisions'));
            const events = filterByUser(localData.events || getLocalStorageData('events'));
            const additionalTasks = filterByUser(localData.additionalTasks || getLocalStorageData('additional_tasks'));

            const result = document.getElementById('wawanResult');
            const totalActivities = tasks.length + supervisions.length + events.length + additionalTasks.length;
            
            if (totalActivities > 0) {
                result.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Aktivitas Wawan Ditemukan</h4>
                        <p><strong>Total:</strong> ${totalActivities} aktivitas</p>
                        <ul>
                            <li>Tugas Pokok: ${tasks.length}</li>
                            <li>Supervisi: ${supervisions.length}</li>
                            <li>Kegiatan: ${events.length}</li>
                            <li>Tugas Tambahan: ${additionalTasks.length}</li>
                        </ul>
                        <details>
                            <summary>Detail Aktivitas</summary>
                            <pre>${JSON.stringify({tasks, supervisions, events, additionalTasks}, null, 2)}</pre>
                        </details>
                    </div>
                `;
            } else {
                result.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Aktivitas Wawan Tidak Ditemukan</h4>
                        <p>Tidak ada aktivitas yang ditemukan untuk user: ${userName} (${userId})</p>
                    </div>
                `;
            }
        }

        function showDebugInfo() {
            const debugInfo = {
                localStorage_keys: Object.keys(localStorage),
                user_data: localStorage.getItem('user_data'),
                current_user: localStorage.getItem('current_user'),
                local_database: localStorage.getItem('local-database'),
                app_users: localStorage.getItem('app_users')
            };
            
            document.getElementById('debugInfo').innerHTML = `
                <pre>${JSON.stringify(debugInfo, null, 2)}</pre>
            `;
        }

        // Auto-run basic tests
        window.onload = function() {
            console.log('üöÄ Auto-testing foto profil dan aktivitas Wawan...');
            setTimeout(() => {
                testPhotoProfile();
                testWawanActivities();
            }, 1000);
        };
    </script>
</body>
</html>