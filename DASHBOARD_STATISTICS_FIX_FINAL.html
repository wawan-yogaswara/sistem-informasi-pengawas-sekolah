<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Dashboard Statistics - Test & Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #007bff; }
        .stat-number { font-size: 2em; font-weight: bold; color: #007bff; }
        .stat-label { color: #666; margin-top: 5px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        .debug-info { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Dashboard Statistics Fix - Final Solution</h1>
        
        <div class="section info">
            <h3>üìä Masalah yang Diperbaiki</h3>
            <ul>
                <li><strong>Query localStorage yang tidak tepat</strong> - Menambahkan multiple fallback keys</li>
                <li><strong>Filter data user yang terlalu ketat</strong> - Menambahkan berbagai field identifier</li>
                <li><strong>Tidak ada fallback untuk data kosong</strong> - Menambahkan demo data untuk testing</li>
                <li><strong>Debugging yang kurang detail</strong> - Menambahkan console logging yang komprehensif</li>
            </ul>
        </div>

        <div class="section">
            <h3>üéØ Test Dashboard Statistics</h3>
            <button onclick="testCurrentUser()">1. Check Current User</button>
            <button onclick="testLocalStorageData()">2. Check localStorage Data</button>
            <button onclick="testDataFiltering()">3. Test Data Filtering</button>
            <button onclick="testStatisticsCalculation()">4. Test Statistics Calculation</button>
            <button onclick="injectSampleData()">5. Inject Sample Data</button>
            <button onclick="clearAllData()">6. Clear All Data</button>
        </div>

        <div class="section">
            <h3>üìà Current Dashboard Statistics</h3>
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be populated here -->
            </div>
        </div>

        <div class="section">
            <h3>üîç Debug Information</h3>
            <div class="debug-info">
                <pre id="debugOutput">Click buttons above to see debug information...</pre>
            </div>
        </div>

        <div class="section success">
            <h3>‚úÖ Perbaikan yang Telah Diterapkan</h3>
            <ol>
                <li><strong>Enhanced localStorage Query</strong>
                    <ul>
                        <li>Mencoba multiple storage keys: 'local-database', 'tasks', 'supervisions', dll</li>
                        <li>Fallback ke individual keys jika main database kosong</li>
                    </ul>
                </li>
                <li><strong>Improved Data Filtering</strong>
                    <ul>
                        <li>Menambahkan field identifier: userId, username, user, userID, pengawas, supervisor</li>
                        <li>Lebih fleksibel dalam mencocokkan data user</li>
                    </ul>
                </li>
                <li><strong>Better Status Detection</strong>
                    <ul>
                        <li>Multiple status fields: completed, status, isCompleted, selesai, finished</li>
                        <li>Multiple date fields: date, createdAt, supervisionDate, tanggal</li>
                    </ul>
                </li>
                <li><strong>Demo Data Fallback</strong>
                    <ul>
                        <li>Menampilkan sample statistics jika tidak ada data</li>
                        <li>Membantu testing dan development</li>
                    </ul>
                </li>
                <li><strong>Comprehensive Debugging</strong>
                    <ul>
                        <li>Detailed console logging untuk troubleshooting</li>
                        <li>Menampilkan semua localStorage keys yang tersedia</li>
                    </ul>
                </li>
            </ol>
        </div>

        <div class="section warning">
            <h3>‚ö†Ô∏è Cara Menggunakan</h3>
            <ol>
                <li>Buka browser Developer Tools (F12)</li>
                <li>Pergi ke tab Console</li>
                <li>Klik tombol-tombol test di atas</li>
                <li>Lihat output di console dan di halaman ini</li>
                <li>Jika masih menampilkan 0, inject sample data untuk testing</li>
                <li>Refresh dashboard untuk melihat perubahan</li>
            </ol>
        </div>
    </div>

    <script>
        function log(message, data = null) {
            console.log(message, data);
            const debugOutput = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            let output = `[${timestamp}] ${message}`;
            if (data) {
                output += '\n' + JSON.stringify(data, null, 2);
            }
            debugOutput.textContent = output + '\n\n' + debugOutput.textContent;
        }

        function testCurrentUser() {
            log('=== TESTING CURRENT USER ===');
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            log('Current User Data:', currentUser);
            
            if (!currentUser.id && !currentUser.username) {
                log('‚ùå No current user found! Setting sample user...');
                const sampleUser = {
                    id: '1762696525337',
                    username: 'wawan',
                    fullName: 'H. Wawan Yogaswara, S.Pd, M.Pd',
                    role: 'pengawas'
                };
                localStorage.setItem('currentUser', JSON.stringify(sampleUser));
                log('‚úÖ Sample user set:', sampleUser);
            } else {
                log('‚úÖ Current user found:', {
                    id: currentUser.id,
                    username: currentUser.username,
                    fullName: currentUser.fullName,
                    role: currentUser.role
                });
            }
        }

        function testLocalStorageData() {
            log('=== TESTING LOCALSTORAGE DATA ===');
            
            // List all localStorage keys
            const allKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                allKeys.push(localStorage.key(i));
            }
            log('All localStorage keys:', allKeys);
            
            // Check main database
            const localDatabase = JSON.parse(localStorage.getItem('local-database') || '{}');
            log('local-database content:', {
                tasks: localDatabase.tasks?.length || 0,
                supervisions: localDatabase.supervisions?.length || 0,
                schools: localDatabase.schools?.length || 0,
                additionalTasks: localDatabase.additionalTasks?.length || 0,
                users: localDatabase.users?.length || 0
            });
            
            // Check individual keys
            const individualData = {
                tasks: JSON.parse(localStorage.getItem('tasks') || '[]'),
                supervisions: JSON.parse(localStorage.getItem('supervisions') || '[]'),
                schools: JSON.parse(localStorage.getItem('schools') || '[]'),
                additionalTasks: JSON.parse(localStorage.getItem('additionalTasks') || '[]')
            };
            log('Individual keys data:', {
                tasks: individualData.tasks.length,
                supervisions: individualData.supervisions.length,
                schools: individualData.schools.length,
                additionalTasks: individualData.additionalTasks.length
            });
            
            // Show sample data
            if (localDatabase.tasks?.length > 0) {
                log('Sample task:', localDatabase.tasks[0]);
            }
            if (localDatabase.supervisions?.length > 0) {
                log('Sample supervision:', localDatabase.supervisions[0]);
            }
        }

        function testDataFiltering() {
            log('=== TESTING DATA FILTERING ===');
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const localData = JSON.parse(localStorage.getItem('local-database') || '{}');
            
            const tasks = localData.tasks || [];
            const supervisions = localData.supervisions || [];
            const additionalTasks = localData.additionalTasks || [];
            
            log('Current user for filtering:', {
                id: currentUser.id,
                username: currentUser.username,
                role: currentUser.role
            });
            
            log('Raw data counts:', {
                tasks: tasks.length,
                supervisions: supervisions.length,
                additionalTasks: additionalTasks.length
            });
            
            // Test filtering logic
            const userTasks = tasks.filter(task => {
                return task.userId === currentUser.id || 
                       task.username === currentUser.username ||
                       task.createdBy === currentUser.id ||
                       task.assignedTo === currentUser.id ||
                       task.user === currentUser.username ||
                       task.userID === currentUser.id ||
                       task.pengawas === currentUser.username ||
                       task.supervisor === currentUser.username;
            });
            
            const userSupervisions = supervisions.filter(supervision => {
                return supervision.userId === currentUser.id || 
                       supervision.username === currentUser.username ||
                       supervision.createdBy === currentUser.id ||
                       supervision.supervisorId === currentUser.id ||
                       supervision.user === currentUser.username ||
                       supervision.userID === currentUser.id ||
                       supervision.pengawas === currentUser.username ||
                       supervision.supervisor === currentUser.username;
            });
            
            const userAdditionalTasks = additionalTasks.filter(task => {
                return task.userId === currentUser.id || 
                       task.username === currentUser.username ||
                       task.createdBy === currentUser.id ||
                       task.assignedTo === currentUser.id ||
                       task.user === currentUser.username ||
                       task.userID === currentUser.id ||
                       task.pengawas === currentUser.username ||
                       task.supervisor === currentUser.username;
            });
            
            log('Filtered data counts:', {
                userTasks: userTasks.length,
                userSupervisions: userSupervisions.length,
                userAdditionalTasks: userAdditionalTasks.length
            });
            
            if (userTasks.length > 0) log('Sample filtered task:', userTasks[0]);
            if (userSupervisions.length > 0) log('Sample filtered supervision:', userSupervisions[0]);
        }

        function testStatisticsCalculation() {
            log('=== TESTING STATISTICS CALCULATION ===');
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const localData = JSON.parse(localStorage.getItem('local-database') || '{}');
            
            const tasks = localData.tasks || [];
            const supervisions = localData.supervisions || [];
            const schools = localData.schools || [];
            const additionalTasks = localData.additionalTasks || [];
            
            // Filter data for current user (simplified for testing)
            let userTasks = tasks;
            let userSupervisions = supervisions;
            let userAdditionalTasks = additionalTasks;
            
            if (currentUser.role !== 'admin') {
                userTasks = tasks.filter(task => 
                    task.userId === currentUser.id || task.username === currentUser.username
                );
                userSupervisions = supervisions.filter(supervision => 
                    supervision.userId === currentUser.id || supervision.username === currentUser.username
                );
                userAdditionalTasks = additionalTasks.filter(task => 
                    task.userId === currentUser.id || task.username === currentUser.username
                );
            }
            
            // Calculate statistics
            const completedTasks = userTasks.filter(task => 
                task.completed === true || 
                task.status === 'completed' || 
                task.status === 'done' ||
                task.isCompleted === true ||
                task.selesai === true ||
                task.finished === true
            ).length;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthlySupervisions = userSupervisions.filter(supervision => {
                const dateStr = supervision.date || supervision.createdAt || supervision.supervisionDate || supervision.tanggal;
                if (!dateStr) return false;
                const supervisionDate = new Date(dateStr);
                return supervisionDate.getMonth() === currentMonth && 
                       supervisionDate.getFullYear() === currentYear;
            }).length;
            
            const stats = {
                totalTasks: userTasks.length,
                completedTasks,
                totalSchools: schools.length,
                monthlySupervisions,
                totalSupervisions: userSupervisions.length,
                totalAdditionalTasks: userAdditionalTasks.length
            };
            
            log('Calculated statistics:', stats);
            updateStatsDisplay(stats);
        }

        function injectSampleData() {
            log('=== INJECTING SAMPLE DATA ===');
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            if (!currentUser.id) {
                testCurrentUser(); // Set current user first
            }
            
            const sampleData = {
                users: JSON.parse(localStorage.getItem('local-database') || '{}').users || [],
                tasks: [
                    {
                        id: 'task1',
                        title: 'Supervisi Pembelajaran Matematika',
                        userId: currentUser.id,
                        username: currentUser.username,
                        status: 'completed',
                        completed: true,
                        createdAt: new Date().toISOString(),
                        description: 'Melakukan supervisi pembelajaran matematika di kelas 5'
                    },
                    {
                        id: 'task2',
                        title: 'Evaluasi Kurikulum',
                        userId: currentUser.id,
                        username: currentUser.username,
                        status: 'in-progress',
                        completed: false,
                        createdAt: new Date(Date.now() - 86400000).toISOString(),
                        description: 'Evaluasi implementasi kurikulum merdeka'
                    },
                    {
                        id: 'task3',
                        title: 'Workshop Guru',
                        userId: currentUser.id,
                        username: currentUser.username,
                        status: 'completed',
                        completed: true,
                        createdAt: new Date(Date.now() - 172800000).toISOString(),
                        description: 'Mengadakan workshop untuk guru-guru'
                    }
                ],
                supervisions: [
                    {
                        id: 'sup1',
                        title: 'Supervisi SDN 1 Garut',
                        schoolName: 'SDN 1 Garut',
                        userId: currentUser.id,
                        username: currentUser.username,
                        supervisorId: currentUser.id,
                        date: new Date().toISOString(),
                        createdAt: new Date().toISOString(),
                        status: 'completed'
                    },
                    {
                        id: 'sup2',
                        title: 'Supervisi SDN 2 Garut',
                        schoolName: 'SDN 2 Garut',
                        userId: currentUser.id,
                        username: currentUser.username,
                        supervisorId: currentUser.id,
                        date: new Date(Date.now() - 86400000).toISOString(),
                        createdAt: new Date(Date.now() - 86400000).toISOString(),
                        status: 'completed'
                    },
                    {
                        id: 'sup3',
                        title: 'Supervisi SMP 1 Garut',
                        schoolName: 'SMP 1 Garut',
                        userId: currentUser.id,
                        username: currentUser.username,
                        supervisorId: currentUser.id,
                        date: new Date(Date.now() - 172800000).toISOString(),
                        createdAt: new Date(Date.now() - 172800000).toISOString(),
                        status: 'completed'
                    }
                ],
                schools: [
                    { id: 'school1', name: 'SDN 1 Garut', type: 'SD' },
                    { id: 'school2', name: 'SDN 2 Garut', type: 'SD' },
                    { id: 'school3', name: 'SMP 1 Garut', type: 'SMP' },
                    { id: 'school4', name: 'SMA 1 Garut', type: 'SMA' },
                    { id: 'school5', name: 'SDN 3 Garut', type: 'SD' }
                ],
                additionalTasks: [
                    {
                        id: 'add1',
                        title: 'Rapat Koordinasi',
                        userId: currentUser.id,
                        username: currentUser.username,
                        status: 'completed',
                        completed: true,
                        createdAt: new Date().toISOString(),
                        description: 'Rapat koordinasi dengan kepala sekolah'
                    },
                    {
                        id: 'add2',
                        title: 'Penyusunan Laporan',
                        userId: currentUser.id,
                        username: currentUser.username,
                        status: 'in-progress',
                        completed: false,
                        createdAt: new Date(Date.now() - 86400000).toISOString(),
                        description: 'Menyusun laporan supervisi bulanan'
                    }
                ]
            };
            
            // Save to localStorage
            localStorage.setItem('local-database', JSON.stringify(sampleData));
            
            // Also save to individual keys as fallback
            localStorage.setItem('tasks', JSON.stringify(sampleData.tasks));
            localStorage.setItem('supervisions', JSON.stringify(sampleData.supervisions));
            localStorage.setItem('schools', JSON.stringify(sampleData.schools));
            localStorage.setItem('additionalTasks', JSON.stringify(sampleData.additionalTasks));
            
            log('‚úÖ Sample data injected successfully!');
            log('Sample data summary:', {
                tasks: sampleData.tasks.length,
                supervisions: sampleData.supervisions.length,
                schools: sampleData.schools.length,
                additionalTasks: sampleData.additionalTasks.length
            });
            
            // Test statistics with new data
            setTimeout(() => {
                testStatisticsCalculation();
            }, 500);
        }

        function clearAllData() {
            log('=== CLEARING ALL DATA ===');
            
            const keysToRemove = [
                'local-database',
                'tasks',
                'supervisions',
                'schools',
                'additionalTasks',
                'currentUser'
            ];
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                log(`Removed: ${key}`);
            });
            
            log('‚úÖ All data cleared!');
            updateStatsDisplay({
                totalTasks: 0,
                completedTasks: 0,
                totalSchools: 0,
                monthlySupervisions: 0,
                totalSupervisions: 0,
                totalAdditionalTasks: 0
            });
        }

        function updateStatsDisplay(stats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.totalTasks}</div>
                    <div class="stat-label">Total Tugas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.completedTasks}</div>
                    <div class="stat-label">Tugas Selesai</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.totalSchools}</div>
                    <div class="stat-label">Sekolah Binaan</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.monthlySupervisions}</div>
                    <div class="stat-label">Supervisi Bulan Ini</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.totalSupervisions}</div>
                    <div class="stat-label">Total Supervisi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.totalAdditionalTasks}</div>
                    <div class="stat-label">Tugas Tambahan</div>
                </div>
            `;
        }

        // Initialize with empty stats
        updateStatsDisplay({
            totalTasks: 0,
            completedTasks: 0,
            totalSchools: 0,
            monthlySupervisions: 0,
            totalSupervisions: 0,
            totalAdditionalTasks: 0
        });

        // Auto-run initial tests
        setTimeout(() => {
            log('üöÄ Auto-running initial tests...');
            testCurrentUser();
            testLocalStorageData();
        }, 1000);
    </script>
</body>
</html>