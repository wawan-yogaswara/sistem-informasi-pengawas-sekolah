<!DOCTYPE html>
<html>
<head>
    <title>Emergency Debug Save</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .error { background-color: #ffebee; color: #c62828; }
        .success { background-color: #e8f5e8; color: #2e7d32; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>üîß Emergency Debug Save Additional Tasks</h1>
    
    <div>
        <button onclick="step1()">Step 1: Check Login Status</button>
        <button onclick="step2()">Step 2: Test localStorage Save</button>
        <button onclick="step3()">Step 3: Test Form Data</button>
        <button onclick="step4()">Step 4: Clear All Data</button>
    </div>
    
    <div id="results"></div>

    <script>
        function addResult(message, isError = false) {
            const div = document.createElement('div');
            div.className = `result ${isError ? 'error' : 'success'}`;
            div.innerHTML = message;
            document.getElementById('results').appendChild(div);
        }

        function step1() {
            console.log('üîç Step 1: Checking login status...');
            
            try {
                const userData = localStorage.getItem('auth_user');
                const token = localStorage.getItem('auth_token');
                
                if (!userData || !token) {
                    addResult('‚ùå No login data found. Please login first!', true);
                    return;
                }
                
                const user = JSON.parse(userData);
                addResult(`‚úÖ Login OK - User: ${user.username} (ID: ${user.id})`);
                
                console.log('User data:', user);
                
            } catch (error) {
                addResult(`‚ùå Error checking login: ${error.message}`, true);
            }
        }

        function step2() {
            console.log('üíæ Step 2: Testing localStorage save...');
            
            try {
                const userData = localStorage.getItem('auth_user');
                if (!userData) {
                    addResult('‚ùå Please run Step 1 first!', true);
                    return;
                }
                
                const user = JSON.parse(userData);
                
                // Create test data
                const testTask = {
                    id: Date.now().toString(),
                    title: 'Test Emergency Debug',
                    description: 'Test deskripsi emergency',
                    date: new Date().toISOString().split('T')[0],
                    status: 'pending',
                    photo: null,
                    user_id: user.id,
                    created_at: new Date().toISOString()
                };
                
                // Save to localStorage
                const existingTasks = JSON.parse(localStorage.getItem('additional_tasks_data') || '[]');
                existingTasks.unshift(testTask);
                localStorage.setItem('additional_tasks_data', JSON.stringify(existingTasks));
                
                addResult(`‚úÖ localStorage save successful! Task ID: ${testTask.id}`);
                console.log('Saved task:', testTask);
                
            } catch (error) {
                addResult(`‚ùå localStorage save error: ${error.message}`, true);
            }
        }

        function step3() {
            console.log('üìù Step 3: Testing form data...');
            
            try {
                // Simulate form data
                const formData = new FormData();
                formData.append('title', 'Test Form Data');
                formData.append('description', 'Test deskripsi form');
                formData.append('date', '2024-12-23');
                formData.append('status', 'pending');
                
                // Extract form data
                const title = formData.get('title');
                const description = formData.get('description');
                const date = formData.get('date');
                const status = formData.get('status');
                
                addResult(`‚úÖ Form data extraction successful:`);
                addResult(`- Title: ${title}`);
                addResult(`- Description: ${description}`);
                addResult(`- Date: ${date}`);
                addResult(`- Status: ${status}`);
                
            } catch (error) {
                addResult(`‚ùå Form data error: ${error.message}`, true);
            }
        }

        function step4() {
            console.log('üóëÔ∏è Step 4: Clearing all data...');
            
            try {
                localStorage.removeItem('additional_tasks_data');
                document.getElementById('results').innerHTML = '';
                addResult('‚úÖ All data cleared successfully!');
                
            } catch (error) {
                addResult(`‚ùå Clear data error: ${error.message}`, true);
            }
        }

        // Auto-run step 1 on load
        window.onload = function() {
            step1();
        };
    </script>
</body>
</html>